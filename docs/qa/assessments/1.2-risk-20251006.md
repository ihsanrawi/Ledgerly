# Risk Profile: Story 1.2 - Integrate and Validate hledger Binary

**Date**: 2025-10-06
**Reviewer**: Quinn (Test Architect)
**Story**: 1.2.hledger-binary-integration.md

## Executive Summary

- **Total Risks Identified**: 8
- **Critical Risks (9)**: 0
- **High Risks (6)**: 2
- **Medium Risks (4)**: 1
- **Low Risks (2-3)**: 5
- **Overall Risk Score**: 78/100 (Moderate - acceptable with mitigations)

## Critical Risks Requiring Immediate Attention

**None** - No critical (score 9) risks identified.

## High Risks Requiring Mitigation

### 1. TECH-001: Cross-platform binary compatibility failures

**Score: 6 (High Risk)**
**Probability**: Medium (2) - Multiple platforms (Windows/macOS/Linux) with various versions increases likelihood of edge cases
**Impact**: High (3) - Complete feature failure on affected platforms; users unable to use Ledgerly

**Affected Components**:
- HledgerBinaryManager.cs (platform detection)
- All platform-specific binaries
- Build/release process

**Mitigation**:
- Test on multiple OS versions:
  - Windows: 10, 11 (x64)
  - macOS: 12 (Monterey), 13 (Ventura), 14 (Sonoma) - both x64 and arm64
  - Linux: Ubuntu 20.04, 22.04, Fedora 38, Arch (x64)
- Implement fallback error messaging with OS version detection
- Document minimum OS requirements in release notes
- Add telemetry to detect platform-specific failures in production
- Create platform compatibility matrix in documentation

**Testing Focus**:
- Integration tests on each supported OS version
- E2E test: Extract binary → Execute `hledger --version` → Verify output
- Test on VM/containers for Linux, physical hardware for macOS/Windows

**Residual Risk**: Low - After testing, only exotic OS configurations remain risky

---

### 2. TECH-002: Process spawning limitations in Tauri

**Score: 6 (High Risk)**
**Probability**: Medium (2) - Tauri is newer technology; Week 1 validation gate exists specifically for this concern
**Impact**: High (3) - Would require Electron pivot, significant architecture rework, timeline impact

**Affected Components**:
- HledgerProcessRunner.cs (all process execution)
- Tauri backend integration
- Cross-platform builds

**Mitigation**:
- **Execute Week 1 validation gate IMMEDIATELY** (AC 6)
- Test all hledger commands (not just `--version`):
  - `hledger bal -f test.hledger -O json`
  - `hledger reg -f test.hledger`
  - `hledger check -f test.hledger`
- Test with large files (>1000 transactions, >5MB)
- Test stdout/stderr redirection with large output
- Test process timeout handling (30s, 60s scenarios)
- Document Electron fallback plan with decision criteria
- Prepare Electron migration guide if pivot needed

**Testing Focus**:
- E2E test: Spawn hledger process from Tauri → Parse output → Kill process
- Load test: 10 concurrent hledger processes
- Stress test: Process execution with 100MB output
- Timeout test: Force timeout and verify process cleanup

**Residual Risk**: Medium - Some edge cases may emerge post-deployment; monitoring required

---

## Medium Risks

### 3. PERF-001: Large file processing timeout

**Score: 4 (Medium Risk)**
**Probability**: Medium (2) - User .hledger files can be arbitrarily large; power users may have years of transactions
**Impact**: Medium (2) - Feature unusable for power users with large files; degraded experience

**Affected Components**:
- HledgerProcessRunner.cs (timeout configuration)
- All hledger command executions

**Mitigation**:
- Implement adaptive timeout based on file size:
  - <1MB: 30s
  - 1-10MB: 60s
  - >10MB: 120s
- Add progress indication for long-running operations
- Test with files >50K transactions
- Consider async processing with cancellation tokens
- Add warning for files >10MB: "This may take a minute..."

**Testing Focus**:
- Performance test: Generate 10K, 50K, 100K transaction files
- Timeout test: Verify timeout fires correctly
- Cancellation test: User cancels long operation

**Residual Risk**: Low - Timeout values may need tuning based on real usage

---

## Low Risks (Monitoring Required)

### 4. SEC-001: Arbitrary command injection via hledger arguments

**Score: 3 (Low Risk)**
**Probability**: Low (1) - Internal API only; file paths come from user file picker (trusted source)
**Impact**: High (3) - Arbitrary code execution on user's machine if exploited

**Mitigation**:
- Whitelist allowed hledger commands: `["bal", "reg", "check", "version"]`
- Validate and sanitize all file paths (no shell metacharacters)
- Use `ProcessStartInfo.ArgumentList` (array) NOT `Arguments` (string)
- Never concatenate user input into shell commands
- Add input validation unit tests

**Testing Focus**:
- Security test: Attempt injection with malicious file paths
- Unit test: Validate path sanitization logic

---

### 5. SEC-002: Binary tampering or corruption

**Score: 3 (Low Risk)**
**Probability**: Low (1) - Embedded SHA256 verification; APPDATA location has OS-level protection
**Impact**: High (3) - Malicious code execution if binary replaced

**Mitigation**:
- SHA256 verification on **every execution** (not just first run)
- Store binaries in protected APPDATA location (`%APPDATA%/Ledgerly/bin`)
- Log verification failures with structured logging
- Alert on repeated verification failures
- Consider code signing entire Ledgerly app for release builds

**Testing Focus**:
- Security test: Replace binary with corrupted version → Verify detection
- Unit test: SHA256 verification with known checksums

---

### 6. OPS-001: Binary extraction permission errors on Unix

**Score: 3 (Low Risk)**
**Probability**: Low (1) - Standard `chmod +x` approach; most Unix systems support this
**Impact**: High (3) - Complete failure on restrictive systems

**Mitigation**:
- Detect `chmod` failures and log with specific error codes
- Provide clear error message: "Unable to set executable permissions. Run: `chmod +x ~/.local/share/Ledgerly/bin/hledger-linux-x64`"
- Test on systems with restrictive umask (e.g., 0077)
- Test on filesystems with noexec mount option
- Document manual permission fix in troubleshooting guide

**Testing Focus**:
- Integration test: Simulate permission failure → Verify error handling
- E2E test: Test on Linux with restrictive security policies

---

### 7. DATA-001: Embedded resource extraction failure

**Score: 3 (Low Risk)**
**Probability**: Low (1) - Rare scenario; requires disk full or corrupted .exe
**Impact**: High (3) - Complete feature failure; no hledger binary available

**Mitigation**:
- Check available disk space before extraction (require 50MB free)
- Retry extraction up to 3 times with exponential backoff
- Clear error message: "Failed to extract hledger binary. Ensure 50MB free space in %APPDATA%."
- Include diagnostic info in logs: disk space, permissions, extraction path
- Test on minimal disk space scenarios (<10MB free)

**Testing Focus**:
- Integration test: Simulate disk full → Verify error handling
- Unit test: Retry logic with transient failures

---

### 8. OPS-002: Lack of observability for process failures

**Score: 2 (Low Risk)**
**Probability**: Medium (2) - First implementation; logging patterns not yet mature
**Impact**: Low (1) - Debugging difficulty for developers; not user-facing

**Mitigation**:
- Include correlation IDs in all hledger process logs
- Log full context for every execution:
  - Command: `hledger`
  - Arguments: `["bal", "-f", "/path/to/file.hledger"]`
  - Exit code: 0
  - Stdout: (first 500 chars)
  - Stderr: (full)
  - Execution time: 1.2s
- Add structured logging with Serilog
- Create monitoring dashboard for process execution metrics

**Testing Focus**:
- Code review: Verify all process executions have logging
- Integration test: Execute process → Verify log output format

---

## Risk Distribution

### By Category
- **Technical (TECH)**: 2 risks (2 high)
- **Security (SEC)**: 2 risks (0 critical)
- **Performance (PERF)**: 1 risk (1 medium)
- **Operational (OPS)**: 2 risks (0 critical)
- **Data (DATA)**: 1 risk (0 critical)
- **Business (BUS)**: 0 risks

### By Component
- **HledgerProcessRunner.cs**: 4 risks (TECH-002, PERF-001, SEC-001, OPS-002)
- **HledgerBinaryManager.cs**: 4 risks (TECH-001, SEC-002, OPS-001, DATA-001)
- **Platform binaries**: 2 risks (TECH-001, SEC-002)
- **Tauri integration**: 1 risk (TECH-002)

---

## Risk-Based Testing Strategy

### Priority 1: Critical Risk Tests (Must Pass Before Deployment)

**TECH-001 Mitigation Tests (P0)**:
- Cross-platform binary extraction on Windows 10/11, macOS 12-14, Ubuntu 20.04/22.04
- `hledger --version` execution on all platforms
- Platform detection logic unit tests

**TECH-002 Mitigation Tests (P0)**:
- **Week 1 Tauri Validation Gate** (AC 6):
  - E2E: Launch Tauri app → Spawn hledger → Parse output
  - Test stdout/stderr redirection
  - Test process timeout and cleanup
  - Test native file I/O from user-selected directory
- All hledger commands: `bal`, `reg`, `check`
- Large file test (>1000 transactions)

### Priority 2: High Risk Tests (Must Pass Before Release)

**PERF-001 Mitigation Tests (P1)**:
- Performance test with 10K, 50K, 100K transaction files
- Adaptive timeout verification
- Cancellation token handling

**SEC-001 Mitigation Tests (P1)**:
- Command injection attempts with malicious paths
- Path sanitization unit tests
- Argument array validation

### Priority 3: Medium/Low Risk Tests (Best Effort)

**SEC-002, OPS-001, DATA-001, OPS-002 (P2)**:
- SHA256 verification with corrupted binary
- Permission error handling on Unix
- Disk space exhaustion scenarios
- Logging coverage verification

---

## Risk Acceptance Criteria

### Must Fix Before Production
- **TECH-001**: Verify binaries work on all documented platforms
- **TECH-002**: Complete Week 1 Tauri validation gate successfully OR pivot to Electron

### Can Deploy with Mitigation
- **PERF-001**: Adaptive timeout implemented and tested
- **SEC-001**: Command whitelist and argument sanitization in place

### Accepted Risks
- **SEC-002**: SHA256 verification on every run may impact startup time (<100ms)
- **OPS-001**: Exotic Unix configurations may require manual intervention
- **DATA-001**: Extremely rare disk space scenarios may not be recoverable
- **OPS-002**: Observability will improve iteratively with production feedback

---

## Monitoring Requirements

Post-deployment monitoring for:

**Performance Metrics (PERF-001)**:
- hledger process execution time (P50, P95, P99)
- Timeout frequency
- File size distribution

**Security Alerts (SEC-001, SEC-002)**:
- Failed SHA256 verifications
- Command validation failures
- Repeated binary tampering attempts

**Operational Metrics (OPS-001, OPS-002)**:
- Binary extraction failures by OS
- Permission errors by platform
- Process execution errors by command type

**Platform Distribution (TECH-001)**:
- User OS versions
- Binary extraction success rate by platform

---

## Risk Review Triggers

Review and update risk profile when:

- Tauri Week 1 validation gate completes (update TECH-002)
- First production release (validate all risk mitigations)
- New OS versions released (e.g., Windows 12, macOS 15)
- Security vulnerabilities discovered in hledger binary
- User-reported platform-specific failures (update TECH-001)
- Performance degradation reported (update PERF-001)

---

## Deterministic Gate Decision

**Based on Risk Assessment**:
- Any risk score ≥ 9: **FAIL** (unless waived)
- Else if any score ≥ 6: **CONCERNS** ✓ (2 high risks: TECH-001, TECH-002)
- Else: **PASS**

**Recommendation**: Gate = **CONCERNS**

**Unmitigated Risks**:
- TECH-002 (Tauri validation) MUST be completed in Week 1 per AC 6
- TECH-001 (cross-platform testing) MUST be verified before release

**Sign-off Requirements**:
- [ ] Week 1 Tauri validation gate passed on all platforms
- [ ] Cross-platform binaries tested on documented OS versions
- [ ] Mitigation strategies implemented for TECH-001, TECH-002
