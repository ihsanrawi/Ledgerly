# NFR Assessment: Epics 4-7 (Consolidated)

**Date:** 2025-10-05
**Reviewer:** Quinn (QA Test Architect)
**Epics:** 4 (Transactions), 5 (Predictions), 6 (Categorization), 7 (Reports)
**Scope:** Security, Performance, Reliability, Maintainability

---

## Epic 4: Transaction Management (CRUD)

### Executive Summary

| NFR Area | Status | Quality Score |
|----------|--------|---------------|
| Security | CONCERNS | -10 |
| Performance | CONCERNS | -10 |
| Reliability | PASS | 0 |
| Maintainability | PASS | 0 |

**Overall Quality Score:** 80/100
**Risk Level:** 🟨 MEDIUM

### Key Findings

**Security CONCERNS:**
1. **Input Validation Gaps**
   - Amount field: No min/max validation (Story 4.1)
   - Date field: No future date prevention
   - Memo field: No length limit (could exceed .hledger line limits)
   - **Fix:** Add FluentValidation rules (2 hours)

2. **Batch Delete Authorization**
   - Story 4.4: No confirmation count validation (user could delete 1000s accidentally)
   - **Fix:** Add "Are you sure? This will delete 127 transactions" with exact count (1 hour)

**Performance CONCERNS:**
1. **Auto-Complete N+1 Queries**
   - Story 4.3: Queries last 1,000 txns on every keystroke (300ms debounce helps but not enough)
   - **Fix:** Preload payee/category lists into memory (2 hours)

2. **No Search Performance Test**
   - NFR3 (<1s search for 10,000 txns) not validated
   - **Fix:** Add test in Story 4.5 (3 hours)

3. **Batch Operations No Bulk Update**
   - Story 4.4: Update N transactions = N SQL updates (not batched)
   - **Fix:** Use EF Core `ExecuteUpdateAsync` (2 hours)

**Reliability PASS:**
- Edit/delete use optimistic locking (concurrency handled)
- Toast notifications confirm actions
- Validation before database updates

**Maintainability PASS:**
- Clear CRUD patterns
- Reusable form components (Story 4.1-4.2)

---

## Epic 5: Predictive Analytics & Cash Flow

### Executive Summary

| NFR Area | Status | Quality Score |
|----------|--------|---------------|
| Security | PASS | 0 |
| Performance | CONCERNS | -10 |
| Reliability | FAIL | -20 |
| Maintainability | CONCERNS | -10 |

**Overall Quality Score:** 60/100
**Risk Level:** 🔴 **HIGH** - Algorithm accuracy unvalidated

### Key Findings

**Security PASS:**
- No user input (background job)
- Read-only predictions

**Performance CONCERNS:**
1. **Prediction Algorithm Complexity**
   - Story 5.2: O(n²) pattern matching (all txns × all payees)
   - For 5,000 txns: 25M comparisons
   - **Fix:** Index by payee, filter by date range first (4 hours)

2. **Nightly Job Could Block Dashboard**
   - No explicit background job isolation
   - **Fix:** Use Wolverine scheduled handler with retry policy (2 hours)

**Reliability FAIL:**
1. **80% Accuracy Target Not Enforceable**
   - Story 5.1: Creates labeled dataset but Story 5.2 doesn't fail if <80%
   - **CRITICAL:** Add assertion in integration test:
     ```csharp
     Assert.True(accuracy >= 0.80, $"Accuracy {accuracy:P} below 80% threshold");
     ```
   - **Effort:** 1 hour

2. **No Confidence Scoring**
   - FR19 deferred to Phase 2, but Story 5.3 shows "confidence shading" without implementation
   - **Fix:** Either implement or remove from Story 5.3 AC #4 (3 hours to implement)

3. **Overdraft Prediction Edge Cases**
   - Story 5.4: No handling for variable income (freelancers), one-time expenses
   - **Fix:** Add "prediction confidence" disclaimer (1 hour docs)

**Maintainability CONCERNS:**
1. **Algorithm Not Testable**
   - Story 5.2: No explanation of how to test "±10% amount, ±5 days monthly"
   - **Fix:** Extract algorithm to pure function with unit tests (4 hours)

---

## Epic 6: Categorization (Ledger File Generation)

**Note:** Epic title mismatch - PRD says "Categorize Transaction" but epic-details.md shows "Ledger File Generation." Assuming categorization based on Story 6.x content showing auto-suggest + learning.

### Executive Summary

| NFR Area | Status | Quality Score |
|----------|--------|---------------|
| Security | PASS | 0 |
| Performance | PASS | 0 |
| Reliability | CONCERNS | -10 |
| Maintainability | PASS | 0 |

**Overall Quality Score:** 90/100
**Risk Level:** 🟢 LOW

### Key Findings

**Security PASS:**
- Simple keyword matching (no injection risks)
- ImportRules table validated

**Performance PASS:**
- Story 6.2: Real-time generation from SQLite (fast)
- Memory-based rule matching

**Reliability CONCERNS:**
1. **Ledger Validation Only Tests Simple Transactions**
   - Story 6.3 AC #4: "100% validation for simple txns; splits/transfers not supported"
   - **Risk:** Users expect full compatibility
   - **Fix:** Add prominent documentation (1 hour)

2. **Export Path Not Validated**
   - Story 6.4: User selects destination but no path traversal check
   - **Fix:** Validate export path (30 minutes)

**Maintainability PASS:**
- Template-based generation (easy to modify)
- 50+ test files collected (Story 6.1)

---

## Epic 7: Reporting & Data Export

### Executive Summary

| NFR Area | Status | Quality Score |
|----------|--------|---------------|
| Security | CONCERNS | -10 |
| Performance | PASS | 0 |
| Reliability | PASS | 0 |
| Maintainability | PASS | 0 |

**Overall Quality Score:** 90/100
**Risk Level:** 🟢 LOW (Optional Epic)

### Key Findings

**Security CONCERNS:**
1. **CSV Export Re-Introduces Injection Risk**
   - Story 7.3: CSV export without sanitization (same as Epic 2 issue)
   - **Fix:** Reuse Epic 2 sanitization logic (1 hour)

**Performance PASS:**
- Report generation <5s (Story 7.1 AC #6 endpoint)
- PDF/CSV generation offloaded to client (jsPDF)

**Reliability PASS:**
- UTF-8 encoding specified (Story 7.3 AC #6)
- File save dialog prevents overwrites

**Maintainability PASS:**
- Reuses drill-down from Epic 3
- Chart components from Epic 3

---

## Cross-Epic NFR Summary

### Security Risk Heatmap

| Epic | Security Risk | Critical Issues |
|------|--------------|----------------|
| Epic 1 | 🟡 MEDIUM | Binary verification gaps |
| Epic 2 | 🔴 **HIGH** | **CSV injection (RCE)** |
| Epic 3 | 🟢 LOW | None |
| Epic 4 | 🟡 MEDIUM | Input validation gaps |
| Epic 5 | 🟢 LOW | None |
| Epic 6 | 🟢 LOW | None |
| Epic 7 | 🟡 MEDIUM | CSV export injection |

### Performance Risk Heatmap

| Epic | Performance Risk | Critical Issues |
|------|-----------------|----------------|
| Epic 1 | 🟢 LOW | None |
| Epic 2 | 🔴 **HIGH** | **No NFR2 test, O(n²) duplicate detection** |
| Epic 3 | 🟡 MEDIUM | No unified query, missing indexes |
| Epic 4 | 🟡 MEDIUM | No NFR3 test, N+1 queries |
| Epic 5 | 🔴 **HIGH** | **O(n²) pattern matching** |
| Epic 6 | 🟢 LOW | None |
| Epic 7 | 🟢 LOW | None |

### Reliability Risk Heatmap

| Epic | Reliability Risk | Critical Issues |
|------|-----------------|----------------|
| Epic 1 | 🟡 MEDIUM | Binary not found recovery |
| Epic 2 | 🔴 **HIGH** | **No rollback for partial imports** |
| Epic 3 | 🟡 MEDIUM | Cache sync validation |
| Epic 4 | 🟢 LOW | None |
| Epic 5 | 🔴 **CRITICAL** | **80% accuracy not enforceable** |
| Epic 6 | 🟡 MEDIUM | Limited .hledger compatibility |
| Epic 7 | 🟢 LOW | None |

---

## Gate-Ready YAML Block (Epics 4-7)

```yaml
epic4_nfr_validation:
  _epic: "Epic 4: Transaction Management"
  _quality_score: 80
  security:
    status: CONCERNS
    notes: "Input validation gaps (amount min/max, date future, memo length)"
  performance:
    status: CONCERNS
    notes: "Auto-complete N+1 queries, no NFR3 test, batch operations not optimized"
  reliability:
    status: PASS
  maintainability:
    status: PASS

epic5_nfr_validation:
  _epic: "Epic 5: Predictive Analytics"
  _quality_score: 60
  _risk_level: HIGH
  security:
    status: PASS
  performance:
    status: CONCERNS
    notes: "O(n²) pattern matching algorithm"
  reliability:
    status: FAIL
    notes: "CRITICAL: 80% accuracy target not enforceable in tests"
  maintainability:
    status: CONCERNS
    notes: "Algorithm not unit-testable (not pure function)"

epic6_nfr_validation:
  _epic: "Epic 6: Ledger File Generation"
  _quality_score: 90
  security:
    status: PASS
  performance:
    status: PASS
  reliability:
    status: CONCERNS
    notes: "Limited .hledger compatibility (simple txns only)"
  maintainability:
    status: PASS

epic7_nfr_validation:
  _epic: "Epic 7: Reporting"
  _quality_score: 90
  security:
    status: CONCERNS
    notes: "CSV export injection (reuse Epic 2 sanitization)"
  performance:
    status: PASS
  reliability:
    status: PASS
  maintainability:
    status: PASS
```

---

## Top 10 Critical Issues (All Epics)

### 1. Epic 2: CSV Injection (RCE)
**Severity:** CRITICAL
**Impact:** Remote code execution via formula injection
**Effort:** 3 hours
**Epic:** 2

### 2. Epic 5: Accuracy Target Not Enforceable
**Severity:** CRITICAL
**Impact:** FR17 (80% recurring detection) could silently fail
**Effort:** 1 hour
**Epic:** 5

### 3. Epic 2: No Rollback for Partial Import Failures
**Severity:** HIGH
**Impact:** Data inconsistency (NFR11 violation)
**Effort:** 4 hours
**Epic:** 2

### 4. Epic 2: No Performance Test (NFR2)
**Severity:** HIGH
**Impact:** Import time unknown, could exceed 5s
**Effort:** 4 hours
**Epic:** 2

### 5. Epic 2: O(n²) Duplicate Detection
**Severity:** HIGH
**Impact:** Slow imports for large datasets
**Effort:** 2 hours
**Epic:** 2

### 6. Epic 3: Missing Database Indexes
**Severity:** HIGH
**Impact:** Dashboard load could exceed 2s (NFR1)
**Effort:** 1 hour
**Epic:** 3

### 7. Epic 3: Cache Out-of-Sync Detection
**Severity:** HIGH
**Impact:** Displays stale data (NFR11 risk)
**Effort:** 3 hours
**Epic:** 3

### 8. Epic 5: O(n²) Pattern Matching
**Severity:** HIGH
**Impact:** Nightly job could take minutes (blocks dashboard)
**Effort:** 4 hours
**Epic:** 5

### 9. Epic 1: Binary Extraction Security
**Severity:** HIGH
**Impact:** Malicious binary substitution
**Effort:** 2 hours
**Epic:** 1

### 10. Epic 4: No Search Performance Test (NFR3)
**Severity:** MEDIUM
**Impact:** Search time unknown, could exceed 1s
**Effort:** 3 hours
**Epic:** 4

---

## Recommended Timeline Adjustments

| Epic | Original Timeline | Issues Found | Fix Effort | Recommended Timeline |
|------|------------------|--------------|-----------|---------------------|
| Epic 1 | Week 1 | 3 issues | 6 hours | Week 1 ✅ (fits in 5 days) |
| Epic 2 | Week 2-3 | **7 issues** | **17.5 hours** | **Week 2-4** (+1 week) |
| Epic 3 | Week 4 | 4 issues | 9 hours | Week 4-5 ✅ (fits in scope) |
| Epic 4 | Week 5-6 | 5 issues | 12 hours | Week 5-6 ✅ |
| Epic 5 | Week 9-10 | **4 issues** | **10 hours** | **Week 9-10** (fits in time-box) |
| Epic 6 | Week 7-8 | 2 issues | 1.5 hours | Week 7-8 ✅ |
| Epic 7 | Week 9-10 | 1 issue | 1 hour | Week 9-10 ✅ |

**Total Additional Effort:** ~57 hours (~1.5 weeks)
**Recommended Buffer:** Add 1 week to Epic 2 (highest risk)

---

**Assessment Complete**
**Files Created:**
- [docs/qa/assessments/epic1-nfr-20251005.md](docs/qa/assessments/epic1-nfr-20251005.md)
- [docs/qa/assessments/epic2-nfr-20251005.md](docs/qa/assessments/epic2-nfr-20251005.md)
- [docs/qa/assessments/epic3-nfr-20251005.md](docs/qa/assessments/epic3-nfr-20251005.md)
- [docs/qa/assessments/epic4-7-nfr-20251005.md](docs/qa/assessments/epic4-7-nfr-20251005.md) (this file)
