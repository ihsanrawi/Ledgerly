# Test Design: Story 1.2 - Integrate and Validate hledger Binary

**Date**: 2025-10-06
**Designer**: Quinn (Test Architect)
**Story**: 1.2.hledger-binary-integration.md

## Test Strategy Overview

- **Total test scenarios**: 34
- **Unit tests**: 15 (44%)
- **Integration tests**: 15 (44%)
- **E2E tests**: 4 (12%)
- **Priority distribution**: P0: 16, P1: 14, P2: 4

**Test Strategy Rationale**:
- **Unit-heavy approach**: Pure logic (platform detection, path validation, SHA256 verification) suited to fast unit tests
- **Integration focus**: Process execution requires real binary interaction - cannot be mocked effectively
- **Limited E2E**: Only critical user journeys (Tauri validation gate) require full E2E coverage

---

## Test Scenarios by Acceptance Criteria

### AC1: hledger binaries downloaded for Windows, macOS, Linux (from hledger.org)

**Testing Approach**: Manual verification + automated integrity checks

#### Scenarios

| ID           | Level       | Priority | Test                                    | Justification                                   |
| ------------ | ----------- | -------- | --------------------------------------- | ----------------------------------------------- |
| 1.2-UNIT-001 | Unit        | P0       | Verify embedded resource paths exist    | Ensure .csproj includes all platform binaries   |
| 1.2-UNIT-002 | Unit        | P0       | Validate SHA256 checksums match release | Critical security check - prevent tampered bins |
| 1.2-INT-001  | Integration | P1       | Extract each platform binary from resources | Verify embedded resource stream reads succeed   |

**Notes**:
- Manual step (not automated): Download binaries from hledger.org and verify checksums before embedding
- Document source URLs and checksums in `Resources/Binaries/README.md`
- SHA256 verification runs on every execution per SEC-002 mitigation

---

### AC2: HledgerBinaryManager.cs extracts binaries to app resources, sets permissions, SHA256 verifies

**Testing Approach**: Unit tests for logic, integration tests for file system interactions

#### Scenarios

| ID           | Level       | Priority | Test                                             | Justification                                              |
| ------------ | ----------- | -------- | ------------------------------------------------ | ---------------------------------------------------------- |
| 1.2-UNIT-003 | Unit        | P0       | Platform detection returns correct OS            | Pure logic - RuntimeInformation.IsOSPlatform()             |
| 1.2-UNIT-004 | Unit        | P0       | GetHledgerBinaryPath returns correct path        | Logic: detect OS → return correct binary name              |
| 1.2-UNIT-005 | Unit        | P0       | SHA256 hash calculation matches expected         | Algorithm correctness - use known hash                     |
| 1.2-UNIT-006 | Unit        | P1       | GetHledgerVersion parses version string correctly | String parsing logic (e.g., "hledger 1.32.3" → "1.32.3")  |
| 1.2-INT-002  | Integration | P0       | Extract binary to APPDATA on first run           | File I/O operation - real filesystem needed                |
| 1.2-INT-003  | Integration | P0       | Binary extraction is idempotent (skip if exists) | Critical: prevent re-extraction on every startup           |
| 1.2-INT-004  | Integration | P0       | SHA256 verification passes for valid binary      | Real binary file verification - cannot mock                |
| 1.2-INT-005  | Integration | P1       | SHA256 verification fails for corrupted binary   | Error handling: modified binary detected (SEC-002)         |
| 1.2-INT-006  | Integration | P1       | Set executable permissions on Unix (chmod +x)    | Unix-specific: verify permissions set correctly (OPS-001)  |
| 1.2-INT-007  | Integration | P2       | Handle permission errors on Unix gracefully      | Error handling: restrictive filesystem (OPS-001 mitigation) |
| 1.2-INT-008  | Integration | P2       | Handle disk space exhaustion during extraction   | Error handling: disk full scenario (DATA-001 mitigation)   |
| 1.2-INT-009  | Integration | P1       | Structured logging includes correlation ID       | Observability: verify Serilog context (OPS-002 mitigation) |

**Key Test Data**:
- **Valid checksums**: Document expected SHA256 for each platform binary
- **Corrupted binary**: Modify 1 byte of binary to trigger verification failure
- **Restricted filesystem**: Test with `umask 0077` or noexec mount

---

### AC3: HledgerProcessRunner.cs executes `hledger --version` successfully on all platforms

**Testing Approach**: Integration tests for real process execution

#### Scenarios

| ID           | Level       | Priority | Test                                                | Justification                                              |
| ------------ | ----------- | -------- | --------------------------------------------------- | ---------------------------------------------------------- |
| 1.2-UNIT-007 | Unit        | P1       | Command argument array construction (no injection)  | Security: validate argument sanitization (SEC-001)         |
| 1.2-UNIT-008 | Unit        | P1       | Exit code mapping to exception types                | Logic: map 0/1/2/127 to correct exception type             |
| 1.2-INT-010  | Integration | P0       | Execute `hledger --version` returns correct version | Critical: prove process spawning works                     |
| 1.2-INT-011  | Integration | P0       | Capture stdout output from process execution        | Core functionality: output parsing depends on this         |
| 1.2-INT-012  | Integration | P0       | Capture stderr output on error                      | Error handling: need stderr for diagnostics                |
| 1.2-INT-013  | Integration | P1       | Process execution includes correlation ID in logs   | Observability: trace requests through logs (OPS-002)       |
| 1.2-INT-014  | Integration | P1       | Handle binary not found (exit code 127)             | Error handling: missing binary scenario                    |
| 1.2-INT-015  | Integration | P2       | Handle malicious file path injection attempt        | Security: verify path sanitization works (SEC-001)         |

**Platform Coverage**:
- Run INT-010, INT-011, INT-012 on Windows, macOS (x64, arm64), Linux
- Document platform-specific behaviors (e.g., line endings, error messages)

---

### AC4: Test executes `hledger bal -f test.hledger` and parses output

**Testing Approach**: Integration tests with real .hledger files

#### Scenarios

| ID           | Level       | Priority | Test                                                | Justification                                              |
| ------------ | ----------- | -------- | --------------------------------------------------- | ---------------------------------------------------------- |
| 1.2-UNIT-009 | Unit        | P1       | Parse JSON output from `hledger bal -O json`        | JSON parsing logic - use sample JSON                       |
| 1.2-UNIT-010 | Unit        | P1       | Handle invalid JSON output gracefully               | Error handling: malformed JSON from hledger                |
| 1.2-INT-016  | Integration | P0       | Execute `hledger bal -f sample.hledger -O json`     | Core functionality: balance retrieval                      |
| 1.2-INT-017  | Integration | P0       | Execute `hledger check` on valid file returns success | Validation: prove file validation works                    |
| 1.2-INT-018  | Integration | P0       | Execute `hledger check` on invalid file returns error | Error handling: detect parse errors (exit code 2)          |
| 1.2-INT-019  | Integration | P1       | Parse balance output with multiple accounts         | Functional: verify JSON deserialization to HledgerBalanceResult |
| 1.2-INT-020  | Integration | P1       | Handle hledger parse error with stderr details      | Error handling: map stderr to HledgerParseException        |
| 1.2-INT-021  | Integration | P1       | Execute on empty .hledger file (edge case)          | Edge case: zero transactions                               |
| 1.2-INT-022  | Integration | P2       | Execute on large .hledger file (>1000 transactions) | Performance: verify no timeout on large files (PERF-001)   |

**Test Data Requirements**:
- **sample.hledger**: 10 transactions, 3 accounts (Assets, Expenses, Income)
- **invalid.hledger**: Malformed transaction (missing closing date)
- **empty.hledger**: Zero transactions (valid syntax)
- **large.hledger**: >1000 transactions generated programmatically

---

### AC5: Cross-platform builds validated (Windows .exe, macOS .dmg, Linux .AppImage)

**Testing Approach**: E2E tests on each platform build

#### Scenarios

| ID          | Level | Priority | Test                                                 | Justification                                              |
| ----------- | ----- | -------- | ---------------------------------------------------- | ---------------------------------------------------------- |
| 1.2-E2E-001 | E2E   | P0       | Build Tauri app for Windows and run hledger          | TECH-001: Verify Windows x64 binary works in packaged app  |
| 1.2-E2E-002 | E2E   | P0       | Build Tauri app for macOS (arm64/x64) and run hledger | TECH-001: Verify macOS binaries work on both architectures |
| 1.2-E2E-003 | E2E   | P0       | Build Tauri app for Linux and run hledger            | TECH-001: Verify Linux binary works in AppImage           |
| 1.2-UNIT-011| Unit  | P1       | Verify build scripts include correct binary targets  | Build configuration: ensure all platforms in build script  |

**E2E Test Procedure** (for each platform):
1. Build Tauri app: `cargo tauri build --target <platform-target>`
2. Install/extract app bundle (.exe, .dmg, .AppImage)
3. Launch app
4. Trigger hledger binary extraction (first run)
5. Execute `hledger --version` via HledgerProcessRunner
6. Verify output: "hledger 1.32.3" (or current version)
7. Execute `hledger bal -f sample.hledger`
8. Verify JSON output parsed successfully

**Build Targets**:
- Windows: `x86_64-pc-windows-msvc`
- macOS arm64: `aarch64-apple-darwin`
- macOS x64: `x86_64-apple-darwin`
- Linux: `x86_64-unknown-linux-gnu`

---

### AC6: Week 1 Validation Gate - Tauri Process Spawning Decision

**Testing Approach**: E2E validation on all platforms - decision gate for Tauri vs Electron

#### Scenarios

| ID          | Level | Priority | Test                                                 | Justification                                              |
| ----------- | ----- | -------- | ---------------------------------------------------- | ---------------------------------------------------------- |
| 1.2-E2E-004 | E2E   | P0       | Tauri Week 1 Validation: Spawn process + file I/O   | TECH-002: Critical decision gate for Tauri viability      |
| 1.2-INT-023 | Integration | P0 | Process timeout after 30 seconds                   | Timeout handling: verify process killed on timeout (PERF-001) |
| 1.2-INT-024 | Integration | P1 | Process spawning with large stdout (>1MB)          | Stress test: ensure stdout buffering works                 |
| 1.2-INT-025 | Integration | P1 | Concurrent process execution (10 simultaneous)     | Load test: verify no resource exhaustion (TECH-002)        |
| 1.2-UNIT-012| Unit  | P2       | Adaptive timeout calculation based on file size      | Logic: timeout = f(file_size) (PERF-001 mitigation)       |

**1.2-E2E-004: Tauri Week 1 Validation Gate** (Critical P0 Test)

**Purpose**: Validate Tauri's process spawning and file I/O capabilities before committing to Tauri architecture.

**Test Procedure**:
1. **Launch Tauri app** (built from Story 1.1)
2. **Test File I/O**:
   - Use Tauri file dialog to select a .hledger file from user's filesystem
   - Verify file path returned correctly
   - Read file contents via Tauri file system API
3. **Test Process Spawning**:
   - Spawn hledger process via HledgerProcessRunner
   - Pass file path to `hledger bal -f <path>`
   - Verify stdout redirected correctly
   - Verify stderr captured if errors occur
4. **Test Process Control**:
   - Spawn long-running hledger process (with large file)
   - Trigger timeout after 30 seconds
   - Verify process killed gracefully
5. **Platform Coverage**:
   - Test on Windows 11, macOS 14, Ubuntu 22.04
6. **Success Criteria**:
   - All process executions succeed
   - No permission errors
   - Stdout/stderr capture works reliably
   - Timeouts enforce correctly
7. **Failure Criteria** (trigger Electron pivot):
   - Process spawning fails on any platform
   - Stdout/stderr capture unreliable
   - Permission errors blocking functionality

**Deliverable**: Validation report documenting:
- PASS/FAIL decision
- Platform-specific observations
- Blockers encountered (if any)
- Recommendation: Proceed with Tauri OR Pivot to Electron

---

## Additional Test Scenarios (Coverage Completeness)

### Error Handling & Edge Cases

| ID           | Level       | Priority | Test                                                | Justification                                              |
| ------------ | ----------- | -------- | --------------------------------------------------- | ---------------------------------------------------------- |
| 1.2-UNIT-013 | Unit        | P1       | Handle null/empty file path arguments               | Input validation: prevent NullReferenceException           |
| 1.2-UNIT-014 | Unit        | P1       | Handle unsupported OS platform detection            | Edge case: what if running on FreeBSD, etc.?               |
| 1.2-UNIT-015 | Unit        | P2       | Handle special characters in file paths (spaces, &#) | Edge case: ensure path escaping works                      |

### Logging & Observability (OPS-002 Mitigation)

**All integration tests must verify**:
- Correlation ID present in logs
- Command, arguments, exit code logged
- Stdout/stderr logged (first 500 chars for stdout, full stderr)
- Execution time logged

---

## Risk Coverage Mapping

| Risk ID   | Test Scenarios                                    | Coverage Level |
| --------- | ------------------------------------------------- | -------------- |
| TECH-001  | 1.2-E2E-001, 1.2-E2E-002, 1.2-E2E-003, 1.2-INT-001 | **High**       |
| TECH-002  | 1.2-E2E-004, 1.2-INT-010, 1.2-INT-023, 1.2-INT-025 | **High**       |
| SEC-001   | 1.2-UNIT-007, 1.2-INT-015                          | **Medium**     |
| SEC-002   | 1.2-INT-004, 1.2-INT-005                           | **Medium**     |
| PERF-001  | 1.2-INT-022, 1.2-INT-023, 1.2-UNIT-012             | **Medium**     |
| OPS-001   | 1.2-INT-006, 1.2-INT-007                           | **Medium**     |
| DATA-001  | 1.2-INT-008                                        | **Low**        |
| OPS-002   | 1.2-INT-009, 1.2-INT-013 + all integration tests   | **High**       |

**All critical risks (TECH-001, TECH-002) have comprehensive test coverage at multiple levels.**

---

## Test Data Requirements

### 1. sample.hledger (Primary Test File)

```hledger
; Ledgerly Test Data
; 10 transactions, 3 accounts

2025-01-01 Opening Balance
    Assets:Checking                $1000.00
    Equity:Opening Balances

2025-01-05 Grocery Store
    Expenses:Groceries              $52.30
    Assets:Checking

2025-01-10 Salary
    Assets:Checking               $3000.00
    Income:Salary

2025-01-15 Rent Payment
    Expenses:Rent                 $1200.00
    Assets:Checking

2025-01-20 Utilities
    Expenses:Utilities              $85.40
    Assets:Checking

2025-01-25 Restaurant
    Expenses:Dining                 $45.00
    Assets:Checking

2025-01-28 Freelance Income
    Assets:Checking                $500.00
    Income:Freelance

2025-02-01 Gas Station
    Expenses:Transportation         $60.00
    Assets:Checking

2025-02-05 Coffee Shop
    Expenses:Dining                 $12.50
    Assets:Checking

2025-02-10 Salary
    Assets:Checking               $3000.00
    Income:Salary
```

**Expected Balance Output** (for verification):
- Assets:Checking: $5045.80
- Expenses:Groceries: $52.30
- Expenses:Rent: $1200.00
- Expenses:Utilities: $85.40
- Expenses:Dining: $57.50
- Expenses:Transportation: $60.00
- Income:Salary: $6000.00
- Income:Freelance: $500.00

### 2. invalid.hledger (Parse Error Test)

```hledger
2025-01-01 Malformed Transaction
    Assets:Checking                $100.00
    ; Missing second posting - should fail hledger check
```

### 3. empty.hledger (Edge Case)

```hledger
; Empty ledger file - valid syntax, zero transactions
```

### 4. large.hledger (Performance Test)

**Generation script** (create programmatically):
- 1000 transactions spanning 2 years
- 10 accounts (5 expense categories, 2 income, 3 asset accounts)
- Random amounts between $1.00 and $500.00

---

## Recommended Test Execution Order

### Phase 1: Fast Feedback (Unit Tests) - 5 minutes
1. **P0 Unit tests** (1.2-UNIT-001 through 1.2-UNIT-005)
   - Platform detection logic
   - SHA256 calculation
   - Path construction
2. **P1 Unit tests** (1.2-UNIT-006 through 1.2-UNIT-010)
   - Version parsing
   - Exit code mapping
   - JSON parsing

### Phase 2: Integration Validation - 15 minutes
3. **P0 Integration tests** (1.2-INT-001 through 1.2-INT-004, 1.2-INT-010 through 1.2-INT-012, 1.2-INT-016 through 1.2-INT-018)
   - Binary extraction and verification
   - Process execution core functionality
   - Balance retrieval and validation
4. **P1 Integration tests** (remaining INT tests)
   - Error handling scenarios
   - Edge cases
   - Performance tests

### Phase 3: E2E Validation (Critical Gate) - 30 minutes
5. **1.2-E2E-004: Tauri Week 1 Validation Gate** (MUST RUN FIRST)
   - Decision point for Tauri vs Electron
   - Test on all 3 platforms
6. **1.2-E2E-001, 1.2-E2E-002, 1.2-E2E-003** (if E2E-004 passes)
   - Full build validation per platform

### Phase 4: Coverage Completeness (P2) - As time permits
7. **P2 tests**: Error handling edge cases, disk space scenarios, etc.

**Total Estimated Execution Time**: ~50 minutes (excluding build time)

---

## Test Environment Requirements

### Unit Tests
- **No external dependencies**
- Mock filesystem I/O using NSubstitute
- In-memory data only

### Integration Tests
- **Real hledger binary** (extracted to temp directory)
- **Temporary filesystem** (clean up after tests)
- **Test .hledger files** in `tests/TestData/`
- **xUnit IAsyncLifetime** for setup/teardown

### E2E Tests
- **Built Tauri app** (.exe, .dmg, .AppImage)
- **Real operating systems** (VMs or physical hardware)
- Windows 11, macOS 14, Ubuntu 22.04
- **Manual test execution** or Selenium/Playwright for automation

---

## Coverage Gaps Analysis

### ✅ Full Coverage
- Binary extraction and validation (AC2)
- Process execution core functionality (AC3)
- Balance retrieval and parsing (AC4)

### ⚠️ Partial Coverage
- **Build configuration**: Only basic verification (1.2-UNIT-011)
  - Recommendation: Add CI/CD validation for build targets
- **SHA256 verification on every execution**: Only tested once
  - Recommendation: Add integration test for repeated verification

### ❌ No Automated Coverage
- **Manual binary download and checksum verification** (AC1)
  - Recommendation: Document in story completion checklist
- **Electron fallback plan**: No tests for Electron pivot
  - Recommendation: If E2E-004 fails, create new story for Electron migration

---

## Test Code Organization

**Follow VSA co-location pattern**:
```
src/Ledgerly.Api/Common/Hledger/
├── HledgerBinaryManager.cs
├── HledgerProcessRunner.cs
└── Hledger.Tests/
    ├── HledgerBinaryManagerTests.cs
    ├── HledgerProcessRunnerTests.cs
    ├── TestData/
    │   ├── sample.hledger
    │   ├── invalid.hledger
    │   ├── empty.hledger
    │   └── large.hledger
    └── Helpers/
        └── HledgerTestFixture.cs (shared setup/teardown)
```

**Test Naming Convention**:
- Class: `{ComponentName}Tests`
- Method: `{Scenario}_{ExpectedOutcome}` (e.g., `ExtractBinary_FirstRun_CreatesFileInAppData`)

---

## Quality Checklist

Before finalizing test implementation:

- [x] Every AC has test coverage
- [x] Test levels are appropriate (44% unit, 44% integration, 12% E2E)
- [x] No duplicate coverage across levels
- [x] Priorities align with business risk (16 P0 tests for critical functionality)
- [x] Test IDs follow naming convention (1.2-{LEVEL}-{SEQ})
- [x] Scenarios are atomic and independent
- [x] All critical risks (TECH-001, TECH-002) have high coverage
- [x] Week 1 Tauri validation gate identified as critical path

---

## Gate YAML Block

```yaml
test_design:
  scenarios_total: 34
  by_level:
    unit: 15
    integration: 15
    e2e: 4
  by_priority:
    p0: 16
    p1: 14
    p2: 4
  coverage_gaps: []
  critical_tests:
    - id: 1.2-E2E-004
      description: 'Tauri Week 1 Validation Gate'
      risk_mitigation: 'TECH-002 (Tauri process spawning)'
      blocker: true
```

---

## Key Principles Applied

- **Shift left**: 44% unit tests for fast feedback on logic
- **Risk-based**: All critical risks covered with P0 tests
- **Efficient coverage**: No duplicate testing across levels
- **Maintainability**: Co-located tests, clear naming conventions
- **Fast feedback**: Unit tests run in <5 minutes, integration in <15 minutes
- **Decision-driven**: E2E-004 (Tauri gate) explicitly identified as go/no-go decision point

---

## Trace References for Requirements Mapping

**Test design complete for Story 1.2**
- Test design matrix saved: [docs/qa/assessments/1.2-test-design-20251006.md](docs/qa/assessments/1.2-test-design-20251006.md)
- P0 tests identified: **16 critical tests** (must pass before deployment)
- Critical gate test: **1.2-E2E-004** (Tauri Week 1 Validation - blocker for architecture decision)
- Risk coverage: All 8 identified risks have test coverage
