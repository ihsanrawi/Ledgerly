# Requirements Traceability Matrix

## Story: 2.6 - Import Preview and Confirmation

**Date:** 2025-10-17
**QA Analyst:** Quinn (Test Architect)

### Coverage Summary

- **Total Requirements:** 6 Acceptance Criteria
- **Fully Covered:** 5 (83%)
- **Partially Covered:** 0 (0%)
- **Not Covered:** 1 (17%)

---

## Requirement Mappings

### AC1: Preview table displays all transactions with: date, payee, amount, suggested category, duplicate status

**Coverage: FULL**

Given-When-Then Mappings:

#### Unit Test: `import-csv.component.spec.ts::should show confirmation preview when finalizeImport is called`
- **Given:** User has uploaded CSV with transactions and finalized preview
- **When:** finalizeImport() is called
- **Then:** Confirmation preview is shown with all transactions

#### Unit Test: `import-csv.component.spec.ts::should calculate import summary correctly`
- **Given:** Preview data contains 3 transactions with category assignments
- **When:** importSummary() is computed
- **Then:** Summary displays total, skipped, withSuggestions, readyToImport, needsCategorization counts

#### Unit Test: `import-csv.component.spec.ts::should identify duplicate transactions correctly`
- **Given:** Duplicate decisions have been set for transaction at index 0
- **When:** isTransactionDuplicate(0) is called
- **Then:** Returns true for duplicates, false for non-duplicates

---

### AC2: Editable fields: Category (dropdown), Payee (text field for corrections)

**Coverage: FULL**

Given-When-Then Mappings:

#### Unit Test: `import-csv.component.spec.ts::should update edited payee when onPayeeEdit is called`
- **Given:** User is viewing confirmation preview with transaction at index 0
- **When:** User edits payee to "Modified Payee"
- **Then:** editedPayees map is updated with new value at index 0

#### Unit Test: `import-csv.component.spec.ts::should update edited category when onCategoryEdit is called`
- **Given:** User is viewing confirmation preview with transaction at index 1
- **When:** User changes category to "expenses:utilities"
- **Then:** editedCategories map is updated with new value at index 1

#### Unit Test: `import-csv.component.spec.ts::should return edited payee in getCurrentPayee`
- **Given:** Transaction at index 0 has edited payee "Edited Payee"
- **When:** getCurrentPayee(0, "Original Payee") is called
- **Then:** Returns edited payee value

#### Unit Test: `import-csv.component.spec.ts::should return edited category in getCurrentCategory`
- **Given:** Transaction at index 0 has edited category "expenses:shopping"
- **When:** getCurrentCategory(0) is called
- **Then:** Returns edited category value

---

### AC3: Summary shown: "127 transactions found, 23 duplicates skipped, 104 ready to import, 15 need categorization"

**Coverage: FULL**

Given-When-Then Mappings:

#### Unit Test: `import-csv.component.spec.ts::should calculate import summary correctly`
- **Given:** Preview data with 3 total transactions, 0 duplicates, 1 with suggestion, all with categories assigned
- **When:** importSummary() is computed
- **Then:** Returns summary with total=3, skipped=0, withSuggestions=1, readyToImport=3, needsCategorization=0

#### Unit Test: `import-csv.component.spec.ts::should calculate transactions needing categories`
- **Given:** Preview has 3 transactions, only transaction 0 has suggestion
- **When:** transactionsNeedingCategories() is computed
- **Then:** Returns 2 (transactions 1 and 2 need categories)

---

### AC4: "Import" button saves non-duplicate transactions to SQLite

**Coverage: FULL**

Given-When-Then Mappings:

#### Backend Unit Test: `ConfirmImportHandlerTests.cs::HandleAsync_SuccessfulImport_SavesTransactionsToDatabase`
- **Given:** Command with 2 valid non-duplicate transactions
- **When:** Handler processes the command
- **Then:** 2 transactions saved to database with correct payee, amount, and attributes

#### Backend Unit Test: `ConfirmImportHandlerTests.cs::HandleAsync_FiltersDuplicates_SkipsDuplicateTransactions`
- **Given:** Command with 1 non-duplicate and 1 duplicate transaction
- **When:** Handler processes the command
- **Then:** Only 1 non-duplicate transaction is saved, duplicate is skipped

#### Backend Unit Test: `ConfirmImportHandlerTests.cs::HandleAsync_ComputesTransactionHash_ForDuplicateDetection`
- **Given:** Transaction with date, payee, and amount
- **When:** Transaction is saved
- **Then:** Hash is computed using Transaction.ComputeTransactionHash() and stored

#### Backend Unit Test: `ConfirmImportHandlerTests.cs::HandleAsync_SanitizesPayee_RemovesSpecialCharacters`
- **Given:** Transaction with payee containing \n, \r, \t special characters
- **When:** Transaction is saved
- **Then:** Special characters are removed from payee field

#### Frontend Unit Test: `import-csv.component.spec.ts::should send confirm import request with correct data`
- **Given:** User has edited transactions and confirmed import
- **When:** confirmImport() is called
- **Then:** POST /api/import/confirm is sent with edited transaction data

#### Frontend Unit Test: `import-csv.component.spec.ts::should filter out duplicate transactions in confirm import`
- **Given:** 3 transactions where transaction 1 is marked as duplicate
- **When:** confirmImport() is called
- **Then:** Transaction 1 has isDuplicate=true in request body

---

### AC5: Success message: "Imported 104 transactions" with link to Dashboard

**Coverage: FULL**

Given-When-Then Mappings:

#### Frontend Unit Test: `import-csv.component.spec.ts::should reset import state after successful import`
- **Given:** User has confirmed import with 3 transactions
- **When:** API returns success response
- **Then:** Component state is reset (selectedFile, previewData, showConfirmationPreview, editedPayees, editedCategories all cleared)

#### Frontend Unit Test: `import-csv.component.spec.ts::should handle confirm import API error`
- **Given:** User has confirmed import
- **When:** API returns 400 Bad Request error
- **Then:** importing() flag is set to false, preview data remains (not reset)

**Note:** While tests verify state management after successful import, there is no explicit test for the success snackbar message or dashboard navigation link. This is a minor gap but visual confirmation would be needed via manual testing or E2E tests.

---

### AC6: Import history logged (timestamp, file name, transaction count) for troubleshooting

**Coverage: FULL**

Given-When-Then Mappings:

#### Backend Unit Test: `ConfirmImportHandlerTests.cs::HandleAsync_CreatesAuditRecords_CsvImportAndFileAudit`
- **Given:** Command with 1 transaction from "bank_transactions.csv"
- **When:** Handler processes the command
- **Then:** CsvImport audit record is created with fileName, successfulImports, duplicatesSkipped
- **And:** HledgerFileAudit record is created with Operation=CsvImport, fileHashBefore, fileHashAfter, transactionCount

---

## Critical Gaps

### 1. **Integration Tests Missing**

- **Gap:** No end-to-end integration tests for full CSV import workflow (Stories 2.2-2.6)
- **Risk:** HIGH - Cannot verify that backend and frontend work together correctly in real workflow
- **Action:** Implement integration test as specified in story task:
  - Upload CSV with 10 transactions
  - Verify preview table displays correctly
  - Edit 2 payees and 1 category
  - Confirm import
  - Verify 10 transactions in SQLite with Money value objects (INTEGER cents)
  - Verify CsvImport and HledgerFileAudit records created
  - Verify .hledger file contains 10 new transaction entries
  - Test rollback scenario: invalid hledger syntax → verify no transactions persisted

### 2. **Success Snackbar with Dashboard Navigation**

- **Gap:** No explicit test for success snackbar display or "View Dashboard" navigation button
- **Risk:** MEDIUM - AC5 requires success message with link to Dashboard, but tests only verify state reset
- **Action:** Add frontend unit test or E2E test to verify:
  - Success snackbar displays with message "Imported X transactions successfully"
  - "View Dashboard" action button is present
  - Navigation to `/dashboard` route occurs on button click

### 3. **Error Snackbar Display and Retry**

- **Gap:** Test verifies error handling resets state correctly but doesn't verify error snackbar UI
- **Risk:** LOW - Error handling logic is tested, but UI display is not explicitly verified
- **Action:** Add unit test to verify error snackbar shows with retry button

### 4. **Performance Requirements**

- **Gap:** No performance tests for 1000 transaction import (NFR2 from PRD: <5 seconds)
- **Risk:** MEDIUM - Story notes target 1000 transactions in <5 seconds, but no test validates this
- **Action:** Add performance integration test:
  - Generate CSV with 1000 transactions
  - Time full import workflow
  - Assert completion time <5 seconds

---

## Test Design Recommendations

### 1. Integration Test Suite

**Priority: P0 (Must Have)**

Create `tests/Integration.Tests/CsvImportWorkflowIntegrationTests.cs`:

```csharp
[Fact]
public async Task FullCsvImportWorkflow_SuccessfullyImports10Transactions()
{
    // Arrange: Generate CSV with 10 transactions
    // Act: Upload, preview, confirm import
    // Assert: Verify SQLite, hledger file, audit records
}

[Fact]
public async Task FullCsvImportWorkflow_RollbackOnHledgerValidationFailure()
{
    // Arrange: Create invalid hledger transaction
    // Act: Attempt import
    // Assert: Verify no transactions persisted to database
}
```

### 2. Success Snackbar Test

**Priority: P1 (Should Have)**

Add to `import-csv.component.spec.ts`:

```typescript
it('should display success snackbar with dashboard navigation button', (done) => {
  // Arrange: Setup successful import
  // Act: confirmImport()
  // Assert: Verify snackbar message, "View Dashboard" button
});
```

### 3. Performance Test

**Priority: P2 (Nice to Have)**

Create `tests/Integration.Tests/CsvImportPerformanceTests.cs`:

```csharp
[Fact]
public async Task ImportLargeCSV_Completes1000TransactionsUnder5Seconds()
{
    // Arrange: Generate CSV with 1000 transactions
    // Act: Time full import workflow
    // Assert: Total time < 5000ms
}
```

---

## Risk Assessment

### High Risk Requirements

- **AC4 (Import button saves transactions):** CRITICAL business logic, rollback behavior must work correctly
  - **Mitigation:** Integration test needed to verify TransactionScope rollback
  - **Current Coverage:** Unit tests cover handler logic, but real database rollback not tested

### Medium Risk Requirements

- **AC5 (Success message with dashboard link):** User experience depends on this
  - **Mitigation:** Add explicit test for snackbar display and navigation
  - **Current Coverage:** State management tested, but UI display not explicitly verified

### Low Risk Requirements

- **AC1, AC2, AC3, AC6:** Well covered by unit tests with clear Given-When-Then patterns

---

## Quality Indicators

### ✅ Good Coverage

- **Backend Handler Logic:** 7 comprehensive unit tests covering all major scenarios
- **Frontend State Management:** 16 unit tests covering editable fields, summary calculations, API interactions
- **Audit Logging:** Full coverage for CsvImport and HledgerFileAudit record creation
- **Duplicate Filtering:** Multiple tests verify duplicate transactions are skipped correctly
- **Validation:** Payee sanitization, hash computation, category requirements all tested

### ⚠️ Areas Needing Attention

- **Integration Testing:** NO integration tests exist for Story 2.6
- **E2E Testing:** Success snackbar, error snackbar, navigation not explicitly tested
- **Performance Testing:** No tests validate NFR2 (1000 transactions <5 seconds)
- **TransactionScope Rollback:** Unit test limitation noted: "fails due to in-memory DB limitation with TransactionScope - will work in production"

---

## Key Principles Validation

✅ **Requirements Traceability:** Every AC maps to at least one test
✅ **Given-When-Then Clarity:** All test mappings use clear GWT pattern
⚠️ **Test Granularity:** Missing integration tests at component interaction level
⚠️ **Edge Case Coverage:** Missing tests for large CSV files (10K+ transactions)
✅ **NFR Testing:** Audit logging (NFR for troubleshooting) fully covered
⚠️ **NFR Testing:** Performance requirements (NFR2) not explicitly tested

---

## Recommendations Summary

### Must Fix (P0)

1. **Add integration test for full CSV import workflow** - Covers AC4 rollback behavior and end-to-end flow

### Should Fix (P1)

2. **Add explicit test for success snackbar with dashboard navigation** - Covers AC5 user experience requirement
3. **Verify TransactionScope rollback with real database** - Current unit test has in-memory DB limitation

### Nice to Have (P2)

4. **Add performance test for 1000 transaction import** - Validates NFR2 from PRD
5. **Add test for error snackbar display** - Completes error handling coverage
6. **Add edge case test for 10K+ transaction CSV** - Validates timeout handling

---

## Conclusion

Story 2.6 has **strong unit test coverage** with 83% of acceptance criteria fully covered by clear, well-structured tests. The primary gap is **lack of integration testing**, which is critical for verifying the full import workflow including database transactions, hledger file writes, and rollback scenarios.

**Gate Recommendation:** CONCERNS - Strong unit coverage but critical integration test gap

**Next Steps:**
1. Implement integration test for full CSV import workflow (AC4 end-to-end verification)
2. Add explicit test for success snackbar and navigation (AC5 completion)
3. Consider performance testing for NFR validation (optional but recommended)
