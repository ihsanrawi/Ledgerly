# Story 2.3: Automatic Column Detection

## Status
Approved

## Epic

**Epic 2: CSV Import & Smart Data Entry**

[Source: docs/prd/epic-details.md#L80-L166]

**Epic Goal:** Enable users to import bank CSV files with intelligent column detection, manual mapping fallback, duplicate detection, and category suggestion rules.

## Story

**As a** user,
**I want** the app to automatically detect which columns contain date, amount, payee, and memo,
**so that** I don't have to manually map columns every time.

## Acceptance Criteria

1. Heuristic algorithm detects date column (pattern matching: MM/DD/YYYY, YYYY-MM-DD, etc.) with >90% accuracy (FR2)
2. Amount column detected (numeric values, optional currency symbols, decimal separators)
3. Payee/description column detected (text values, typically longest non-numeric column)
4. Memo column detected (optional, secondary text column)
5. Confidence indicators displayed: Green checkmark (high confidence), yellow warning (review needed)
6. Integration test validates detection for 11 CSV samples from Story 2.1 (4 standard, 4 edge cases, 3 malformed) with >90% success rate for standard and edge case samples

## Tasks / Subtasks

- [ ] Backend: Create column detection service (AC: 1, 2, 3, 4)
  - [ ] Create `ColumnDetectionService.cs` in `Features/ImportCsv/` with detection logic
  - [ ] Implement `DetectDateColumn(string[] headers, List<Dictionary<string, string>> sampleRows)` using pattern matching from CSV_FORMAT_ANALYSIS.md
  - [ ] Implement `DetectAmountColumn(string[] headers, List<Dictionary<string, string>> sampleRows)` with numeric validation
  - [ ] Implement `DetectDescriptionColumn(string[] headers, List<Dictionary<string, string>> sampleRows)` using column-name-mapping.json reference
  - [ ] Implement `DetectMemoColumn(string[] headers, List<Dictionary<string, string>> sampleRows)` for secondary text column
  - [ ] Implement confidence scoring (0.0-1.0) based on pattern match quality and data validation
  - [ ] Return `ColumnDetectionResult` DTO with detected mappings and confidence scores

- [ ] Backend: Enhance PreviewCsvResponse DTO with detection results (AC: 5)
  - [ ] Add `DetectedColumnMappings` property to `PreviewCsvResponse.cs`
  - [ ] Add `ColumnMappingConfidence` DTO with field name and confidence score
  - [ ] Update `PreviewCsvHandler` to call `ColumnDetectionService` after parsing
  - [ ] Include confidence indicators in API response

- [ ] Backend: Write unit tests for column detection (AC: 6)
  - [ ] Create `ColumnDetectionServiceTests.cs` in `ImportCsv.Tests/`
  - [ ] Test date column detection for all date formats (MM/DD/YYYY, YYYY-MM-DD, DD.MM.YYYY)
  - [ ] Test amount column detection (single amount, debit/credit split, parentheses for negatives)
  - [ ] Test description column detection with header name variations
  - [ ] Test memo column detection for secondary text fields
  - [ ] Test confidence scoring (high confidence >0.9, medium 0.7-0.9, low <0.7)
  - [ ] Test all 11 CSV samples from Story 2.1 (4 standard, 4 edge cases, 3 malformed)
  - [ ] Verify >90% success rate for standard and edge case samples

- [ ] Backend: Add column mapping validation (AC: 1, 2)
  - [ ] Create `ColumnMappingValidator.cs` with FluentValidation
  - [ ] Validate required fields detected (date and amount mandatory)
  - [ ] Return validation warnings if confidence <0.7 for any required field
  - [ ] Handle detection failure gracefully (return empty mappings, not error)

- [ ] Frontend: Update CSV preview to display detection results (AC: 5)
  - [ ] Modify `import-csv.component.ts` to receive detection results from API
  - [ ] Add confidence indicators to preview table headers:
    - Green checkmark icon for high confidence (>0.9)
    - Yellow warning icon for medium confidence (0.7-0.9)
    - Red alert icon for low confidence (<0.7)
  - [ ] Display detected field type badges on column headers (Date, Amount, Description, Memo)
  - [ ] Add tooltip showing confidence score on hover

- [ ] Frontend: Add manual override UI for low-confidence detections (AC: 5)
  - [ ] Show warning banner if any required field has confidence <0.7: "Column detection needs review"
  - [ ] Add "Review Mapping" button that navigates to manual mapping interface (Story 2.4 will implement full UI)
  - [ ] For MVP: Disable "Next" button if required columns (date, amount) not detected with >0.7 confidence
  - [ ] Display helpful message: "Please review column mapping before proceeding"

- [ ] Frontend: Write component unit tests (AC: 5)
  - [ ] Update `import-csv.component.spec.ts` with detection result tests
  - [ ] Test confidence indicator rendering (green checkmark, yellow warning, red alert)
  - [ ] Test field type badge display on headers
  - [ ] Test warning banner display for low-confidence detection
  - [ ] Test "Next" button disabled state when required fields not detected

- [ ] Integration: Test with all Story 2.1 CSV samples (AC: 6)
  - [ ] Create integration test that uploads all 11 CSV samples
  - [ ] Verify detection accuracy ≥90% for standard samples (4/4 expected)
  - [ ] Verify detection accuracy ≥90% for edge cases (4/4 expected)
  - [ ] Document detection failures in test report
  - [ ] Verify malformed CSVs (3 samples) return low confidence or detection failure (expected behavior)

## Dev Notes

### Previous Story Insights

[Source: Story 2.2 completion notes]

**Key Learnings from Story 2.2:**
- **CSV Parsing Infrastructure Complete:** `CsvParserService` successfully parses 11/11 test samples with encoding and delimiter detection
- **PreviewCsv Endpoint Operational:** `POST /api/import/preview` endpoint returns headers and first 10 sample rows
- **Test Data Available:** 11 CSV samples organized in `tests/TestData/CsvSamples/` (4 standard, 4 edge cases, 3 malformed)
- **Column Name Reference Data:** `column-name-mapping.json` provides patterns for matching common column header variations
- **Format Analysis Complete:** `CSV_FORMAT_ANALYSIS.md` documents date formats, amount patterns, delimiter types

**Relevant Existing Components:**
- `CsvParserService` - Use for parsing CSV file structure
- `PreviewCsvHandler` - Enhance with column detection logic
- `PreviewCsvResponse` - Extend with detection results

### Tech Stack References

[Source: architecture/tech-stack.md]

**Backend Technologies:**
- **Column Detection Logic:** C# 12 with pattern matching and regex
- **Date Parsing:** Built-in `DateTime.TryParseExact()` with multiple format patterns (MM/DD/YYYY, YYYY-MM-DD, DD.MM.YYYY)
- **Validation:** FluentValidation 11.9.1 for column mapping validation
- **Testing:** xUnit 2.7.0, NSubstitute 5.1.0 for mocking

**Frontend Technologies:**
- **Confidence Indicators:** Angular Material icons (check_circle, warning, error)
- **Badges:** Angular Material chips for field type labels
- **Tooltips:** Angular Material tooltips for confidence scores
- **Signals:** Reactive state for detection results

**Reference Data:**
- **Column Patterns:** Load from `tests/TestData/CsvSamples/column-name-mapping.json`
- **Test Samples:** Use all 11 samples from `tests/TestData/CsvSamples/` for validation

### Project Structure Alignment

[Source: architecture/source-tree.md]

**Backend Feature Slice Structure (VSA Pattern):**
```
src/Ledgerly.Api/Features/ImportCsv/
├── CsvParserService.cs               # Existing - CSV parsing
├── ColumnDetectionService.cs         # NEW - Column detection logic
├── PreviewCsvCommand.cs              # Existing
├── PreviewCsvHandler.cs              # MODIFY - Add column detection call
├── PreviewCsvEndpoint.cs             # Existing
├── PreviewCsvValidator.cs            # Existing
├── ColumnMappingValidator.cs         # NEW - Validate detected mappings
└── ImportCsv.Tests/                  # Co-located unit tests
    ├── CsvParserServiceTests.cs      # Existing
    ├── ColumnDetectionServiceTests.cs # NEW - Detection tests
    └── PreviewCsvHandlerTests.cs     # MODIFY - Add detection scenarios
```

**Frontend Feature Module Structure:**
```
src/Ledgerly.Web/src/app/features/import/
├── import-csv.component.ts           # MODIFY - Display detection results
├── import-csv.component.html         # MODIFY - Add confidence indicators
├── import-csv.component.scss         # MODIFY - Style badges and indicators
└── import-csv.component.spec.ts      # MODIFY - Test detection UI
```

**Test Data Location:**
```
tests/TestData/CsvSamples/
├── column-name-mapping.json          # Reference data for detection
├── CSV_FORMAT_ANALYSIS.md            # Format patterns documentation
├── standard/                         # 4 CSV samples for accuracy testing
├── edge-cases/                       # 4 CSV samples for robustness testing
└── malformed/                        # 3 CSV samples for error handling testing
```

### Data Models

[Source: architecture/data-models.md, Story 2.2 implementation]

**New DTOs for This Story:**

**ColumnDetectionResult:**
```csharp
public record ColumnDetectionResult
{
    public Dictionary<string, string> DetectedMappings { get; init; } = new();
    // Key: CSV header name, Value: Field type (date, amount, description, memo, balance)

    public Dictionary<string, decimal> ConfidenceScores { get; init; } = new();
    // Key: Field type, Value: Confidence score (0.0-1.0)

    public List<string> Warnings { get; init; } = new();
    // User-friendly warnings for low-confidence detections

    public bool AllRequiredFieldsDetected { get; init; }
    // True if date and amount detected with confidence >0.7
}
```

**Enhanced PreviewCsvResponse:**
```csharp
public record PreviewCsvResponse
{
    public string[] Headers { get; init; } = Array.Empty<string>();
    public List<Dictionary<string, string>> SampleRows { get; init; } = new();
    public int TotalRowCount { get; init; }
    public string DetectedDelimiter { get; init; } = ",";
    public string DetectedEncoding { get; init; } = "UTF-8";
    public List<CsvParseError> Errors { get; init; } = new();

    // NEW for Story 2.3
    public ColumnDetectionResult? ColumnDetection { get; init; }
}
```

**Column Mapping Reference (from column-name-mapping.json):**
- Date variants: "date", "transaction date", "post date", "posting date", "effective date", "datum"
- Description variants: "description", "payee", "merchant", "memo", "details", "transaction description"
- Amount variants: "amount", "transaction amount", "betrag"
- Debit variants: "debit", "withdrawal", "outflow", "payment"
- Credit variants: "credit", "deposit", "inflow", "receipt"
- Balance variants: "balance", "running balance", "running bal", "saldo"

### API Endpoints

[Source: architecture/rest-api-spec.md, Story 2.2 implementation]

**Enhanced Endpoint (No New Endpoints):**

**POST /api/import/preview**
- **Purpose:** Upload CSV file, parse, detect columns, return preview with detection results
- **Request:** `multipart/form-data` with file upload
- **Response:** `PreviewCsvResponse` with headers, sample rows, format info, **column detection results**
- **New Behavior:** After parsing, call `ColumnDetectionService.DetectColumns()` and include results in response
- **Validation:** Existing file size/extension validation remains

### Component Specifications

[Source: architecture/components.md#L137-L153]

**ImportCsv Feature Slice:**
- **Responsibility:** Complete CSV import workflow - upload, parse, **detect columns**, map fields, suggest categories, detect duplicates
- **This Story's Scope:** Column detection only (automatic mapping phase)

**ColumnDetectionService Component (NEW):**
- **Responsibility:** Analyze CSV headers and sample row data to detect field types using pattern matching
- **Key Methods:**
  - `Task<ColumnDetectionResult> DetectColumns(string[] headers, List<Dictionary<string, string>> sampleRows)`
  - `DetectDateColumn()` - Pattern match date formats from CSV_FORMAT_ANALYSIS.md
  - `DetectAmountColumn()` - Validate numeric patterns, currency symbols
  - `DetectDescriptionColumn()` - Match common payee/merchant patterns
  - `DetectMemoColumn()` - Identify secondary text column
  - `CalculateConfidence()` - Score detection quality (0.0-1.0)
- **Dependencies:** Column name patterns from `column-name-mapping.json`
- **Algorithm:**
  1. **Header Name Matching:** Case-insensitive substring match against known column name variants
  2. **Data Pattern Validation:** Analyze sample rows to confirm detected type (e.g., date column must parse as dates)
  3. **Confidence Scoring:**
     - 1.0: Exact header match + 100% sample row validation
     - 0.9-1.0: Close header match + >90% sample row validation
     - 0.7-0.9: Fuzzy header match + >70% sample row validation
     - <0.7: Weak match or failed validation (manual review required)
  4. **Required Field Check:** Ensure date and amount detected with confidence >0.7

### File Locations and Naming Conventions

[Source: architecture/source-tree.md, architecture/coding-standards.md]

**Backend Files:**
- Feature slice root: `src/Ledgerly.Api/Features/ImportCsv/`
- Service naming: `{Purpose}Service.cs` → `ColumnDetectionService.cs`
- Validator naming: `{Purpose}Validator.cs` → `ColumnMappingValidator.cs`
- Test naming: `{Class}Tests.cs` → `ColumnDetectionServiceTests.cs`

**Frontend Files:**
- Feature module root: `src/Ledgerly.Web/src/app/features/import/`
- Component naming: `import-csv.component.ts` (existing, modify)
- Template: `import-csv.component.html` (modify)
- Styles: `import-csv.component.scss` (modify)

**Reference Data:**
- Column patterns: `tests/TestData/CsvSamples/column-name-mapping.json`
- Format analysis: `tests/TestData/CsvSamples/CSV_FORMAT_ANALYSIS.md`

### Testing Requirements

[Source: architecture/test-strategy-and-standards.md]

**Unit Tests (Backend):**
- **Framework:** xUnit 2.7.0
- **Coverage Target:** 80% minimum
- **Test Location:** `src/Ledgerly.Api/Features/ImportCsv/ImportCsv.Tests/`

**Required Test Cases:**
1. **ColumnDetectionServiceTests:**
   - Detect date column for all 3 date formats (MM/DD/YYYY, YYYY-MM-DD, DD.MM.YYYY)
   - Detect amount column (single amount vs. debit/credit split)
   - Detect description column with header name variations
   - Detect memo column (secondary text field)
   - Calculate confidence scores correctly (high, medium, low)
   - Handle missing required fields gracefully (return low confidence, not error)
   - Test with all 11 CSV samples from Story 2.1
   - Verify >90% success rate for standard and edge cases

2. **ColumnMappingValidatorTests:**
   - Validate required fields present (date, amount)
   - Validate confidence thresholds (warn if <0.7)
   - Handle optional fields (memo, balance)

3. **PreviewCsvHandlerTests (Enhanced):**
   - Verify column detection called after parsing
   - Verify detection results included in response
   - Test error handling if detection service fails

**Unit Tests (Frontend):**
- **Framework:** Jest 29.7.0
- **Coverage Target:** 70% minimum
- **Test Location:** `tests/unit/features/import/import-csv.component.spec.ts`

**Required Test Cases:**
1. **import-csv.component.spec.ts (Enhanced):**
   - Render confidence indicators (green checkmark, yellow warning, red alert)
   - Display field type badges on column headers
   - Show warning banner for low-confidence detection
   - Disable "Next" button if required fields not detected
   - Display confidence scores in tooltips

**Integration Tests:**
- **Test all 11 CSV samples** from `tests/TestData/CsvSamples/`
- **Success Criteria:** ≥90% accuracy for standard (4 samples) and edge cases (4 samples)
- **Expected Failures:** Malformed CSVs (3 samples) should return low confidence or detection failure
- **Test Report:** Document which samples passed/failed detection

### Coding Standards

[Source: architecture/coding-standards.md]

**CRITICAL RULES (AI MUST FOLLOW):**

1. **Logging:** Use Serilog for all logging - NO `console.log` in backend code
2. **Async/Await:** Use `async`/`await` for all I/O operations - NEVER `.Result` or `.Wait()`
3. **Dependency Injection:** Constructor injection only for ColumnDetectionService, ILogger
4. **FluentValidation:** All column mapping validations MUST use ColumnMappingValidator
5. **Correlation IDs:** Every API request MUST include correlation ID for tracing
6. **Error Handling:** Throw specific exceptions - create `ColumnDetectionException` if needed
7. **Nullable Reference Types:** Enable and respect C# nullable annotations

**Code Style:**
- **C#:** Follow StyleCop rules configured in `.editorconfig`
- **TypeScript:** Follow ESLint 8.57.0 Angular recommended rules
- **Formatting:** Use Prettier 3.2.5 for frontend code

**AAA Pattern for Unit Tests:**
- **Arrange:** Load CSV sample or mock headers/rows
- **Act:** Execute detection method
- **Assert:** Verify detected field types and confidence scores

### Error Handling Strategy

[Source: architecture/error-handling-strategy.md]

**Column Detection Error Handling:**

**Frontend Error Display:**
- Low confidence warnings shown in banner: "Column detection needs review. Please verify mappings before proceeding."
- Required field missing: "Required columns (Date, Amount) not detected. Please map columns manually."

**Backend Error Response Format:**
```json
{
  "errorCode": "COLUMN_DETECTION_FAILED",
  "message": "Unable to detect column types",
  "details": "No date column detected with sufficient confidence",
  "validationErrors": {
    "dateColumn": "No column matched date patterns",
    "amountColumn": "Detected with low confidence (0.65)"
  },
  "timestamp": "2025-10-15T14:30:00Z",
  "traceId": "abc-123-def-456"
}
```

**Logging:**
- Log detection results with correlation ID
- Log confidence scores for all detected fields
- Log warnings for low-confidence detections
- Do NOT log CSV data content (privacy concern)

### Security Considerations

[Source: architecture/security.md]

**Input Validation:**
- Existing CSV file validation remains (size, extension)
- Column detection operates on already-parsed CSV data
- No new security risks introduced

**Data Privacy:**
- Do NOT log CSV content in detection service
- Log only metadata: header names, field types, confidence scores
- Sanitize any error messages that might contain user data

### Performance Considerations

**Detection Algorithm Performance:**
- Analyze headers and first 10 sample rows only (already available from parsing)
- Pattern matching with pre-compiled regex for date detection
- Time complexity: O(headers × patterns × sample rows) ≈ O(10 × 10 × 10) = 1,000 operations (negligible)
- Target: <100ms detection time (included in overall parsing time of <2s for 1,000 rows)

**Optimization:**
- Pre-load `column-name-mapping.json` on service initialization (singleton pattern)
- Cache compiled regex patterns for date validation
- Stop validation early if confidence threshold met (short-circuit)

### Open Questions / Risks

**Risk: Column Detection Accuracy <90% on Real-World Data**
- **Mitigation:** Test with all 12 Story 2.1 samples before marking story complete
- **Fallback:** Manual mapping UI (Story 2.4) available if auto-detection fails
- **Acceptance:** MVP targets ≥90% for standard samples only (edge cases and malformed may fail)

**Risk: Multi-Language Support (German, Spanish headers)**
- **Mitigation:** `column-name-mapping.json` includes German variants ("Datum", "Betrag", "Beschreibung")
- **Future:** Add Spanish, French variants in Phase 2 if user feedback requests

**Question: Should Detection Be Configurable?**
- **Decision for MVP:** No user configuration - use fixed confidence threshold (0.7)
- **Future:** Settings page could allow users to adjust confidence sensitivity

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-15 | 1.0 | Initial story creation from Epic 2 requirements | Bob (Scrum Master) |
| 2025-10-15 | 1.1 | Corrected CSV sample count from 12 to 11 (4 standard, 4 edge cases, 3 malformed) based on validation findings | Sarah (Product Owner) |

## Dev Agent Record

### Agent Model Used

(To be populated by dev agent)

### Debug Log References

(To be populated by dev agent)

### Completion Notes List

(To be populated by dev agent)

### File List

(To be populated by dev agent)

## QA Results

(To be populated by QA agent)
