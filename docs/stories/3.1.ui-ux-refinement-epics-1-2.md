# Story 3.1: UI/UX Refinement - Align Epics 1-2 with Design System

## Status
Approved

## Epic

**Epic 3: Dashboard & Interactive Visualizations**

[Source: docs/prd/epic-details.md#L169-L172]

**Epic Goal:** Build the dashboard-first UI with net worth summary, expense breakdowns, income vs. expense charts, and drill-down navigation.

**Note:** This story is inserted as the FIRST story in Epic 3 to address critical UI/UX deviations from Epic 1-2 before proceeding with new dashboard development.

## Story

**As a** user,
**I want** Epic 1-2 UI components to follow the ai-frontend-prompt.md design specifications,
**so that** the application has a consistent, accessible, mobile-first user experience.

## Acceptance Criteria

### 1. Balance Display Component (Story 1.5) Refinement
- [ ] Apply mobile-first responsive patterns from ai-frontend-prompt.md Section 8
- [ ] Implement design system color tokens (CSS custom properties)
- [ ] Add WCAG AA accessibility compliance (keyboard navigation, ARIA labels)
- [ ] Apply monospace font to financial amounts per design system
- [ ] Ensure dark mode support with proper contrast ratios

### 2. CSV Import Flow Components (Epic 2) Refinement

**Upload Component (Story 2.2):**
- [ ] Implement drag-drop zone styling per ai-frontend-prompt.md Section 3, Step 1
- [ ] Add file picker fallback with proper focus states
- [ ] Show progress indicator for large files (>1000 rows)
- [ ] Apply responsive breakpoints (mobile/tablet/desktop)

**Column Mapping Component (Story 2.4):**
- [ ] Add confidence indicators (green checkmark = >90%, yellow warning)
- [ ] Implement draggable column headers (if not present)
- [ ] Show preview table (first 5 rows) with mapped columns highlighted
- [ ] Add "Save Mapping" option per specification

**Duplicate Detection (Story 2.5):**
- [ ] Implement side-by-side comparison view per ai-frontend-prompt.md Section 3, Step 3
- [ ] Add confidence badges (Green=exact, Yellow=likely, Gray=uncertain)
- [ ] Show differences highlighted in yellow
- [ ] Implement "Skip This", "Import Anyway", "Skip All Remaining" actions

**Preview Component (Story 2.6):**
- [ ] Implement virtualized scrolling for 200-300 rows
- [ ] Add summary footer format: "X found, Y duplicates skipped, Z ready to import, N need categorization"
- [ ] Show category suggestions column with confidence indicators
- [ ] Add learning indicator message: "Ledgerly learns from your corrections to improve future imports"

### 3. Cross-Cutting Improvements
- [ ] Audit all components for WCAG AA compliance (contrast, keyboard nav, screen reader)
- [ ] Apply design system spacing (1.5rem section gaps, 1rem component gaps)
- [ ] Implement focus indicators (2px teal outline per ai-frontend-prompt.md)
- [ ] Test responsive breakpoints: 320px, 768px, 1024px, 1366px, 1920px
- [ ] Validate dark mode styling across all components

## Tasks / Subtasks

- [x] Pre-Implementation: Audit existing components against ai-frontend-prompt.md checklist
  - [x] Document specific deviations per component in audit report using standardized format:
    ```markdown
    ## Component Audit Report

    | Component | Current State | ai-frontend-prompt.md Requirement | Gap Description | Priority | Effort Estimate |
    |-----------|---------------|-----------------------------------|-----------------|----------|-----------------|
    | balance-display | No mobile-first grid | Section 8: Responsive grid with breakpoints | Missing responsive layout, hard-coded desktop widths | CRITICAL | 2h |
    | import-csv | Basic file input | Section 3, Step 1: Drag-drop zone with styling | No drag-drop, no progress indicator | HIGH | 2.5h |
    | manual-mapping | No confidence indicators | Section 3, Step 2: Green/yellow confidence badges | Missing visual confidence feedback | MEDIUM | 1.5h |
    | duplicate-warning | List view only | Section 3, Step 3: Side-by-side comparison | No comparison view, no confidence badges | CRITICAL | 3h |
    | preview | Simple table | Section 3, Step 3: Virtualized scroll + summary | No virtualization, no summary footer | HIGH | 2.5h |

    **Priority Definitions:**
    - CRITICAL: Blocks user workflow or violates WCAG AA
    - HIGH: Significant UX degradation or inconsistency
    - MEDIUM: Nice-to-have improvement, doesn't block functionality
    ```
  - [x] Prioritize fixes (critical vs. nice-to-have) using audit report Priority column
  - [x] Estimate effort per component using audit report Effort Estimate column
  - [x] Validate total effort estimate aligns with story estimate (12-16 hours) - **Actual: 14 hours**
  - [x] Audit report saved to `.ai/component-audit-report.md`

- [ ] Refine Balance Display component (Epic 1)
  - [ ] Review current implementation in `src/Ledgerly.Web/src/app/features/balance/balance-display.component.ts`
  - [ ] Apply responsive grid layout per ai-frontend-prompt.md
  - [ ] Update typography and color tokens from design system
  - [ ] Add accessibility attributes (ARIA labels, keyboard navigation)
  - [ ] Apply monospace font to amounts using CSS custom properties
  - [ ] Implement dark mode support with proper contrast
  - [ ] Test keyboard navigation (Tab, Enter, Escape)
  - [ ] Run accessibility audit with axe DevTools

- [ ] Refine CSV Upload component (Story 2.2)
  - [ ] Review current implementation in `src/Ledgerly.Web/src/app/features/import/import-csv.component.ts`
  - [ ] Implement drag-drop zone styling (teal accent border, hover states)
  - [ ] Add progress indicators for large files (>1000 rows)
  - [ ] Test file picker fallback with keyboard navigation
  - [ ] Apply responsive breakpoints (mobile/tablet/desktop)
  - [ ] Validate dark mode styling

- [ ] Refine Column Mapping component (Story 2.4)
  - [ ] Review current implementation in `src/Ledgerly.Web/src/app/features/import/manual-mapping.component.ts`
  - [ ] Add confidence indicators (green checkmark >90%, yellow warning)
  - [ ] Implement preview table with first 5 rows
  - [ ] Highlight mapped columns in preview
  - [ ] Add "Save Mapping" option if not present
  - [ ] Test drag-drop interactions with keyboard fallback

- [x] Refine Duplicate Detection component (Story 2.5)
  - [x] Review current implementation in `src/Ledgerly.Web/src/app/features/import/duplicate-warning-dialog.component.ts`
  - [x] Implement side-by-side comparison view layout (grid with 2 columns desktop, 1 column mobile)
  - [x] Add confidence badges (Green=exact, Yellow=likely, Gray=uncertain) using MatChipsModule
  - [x] Highlight differences in yellow (#fff3cd light mode, rgba yellow dark mode)
  - [x] Implement action buttons: "Skip This", "Import Anyway", "Skip All Remaining"
  - [x] Add ARIA labels to all buttons for accessibility
  - [x] Apply responsive layout (stacks vertically on mobile <768px)
  - [x] Use CSS custom properties throughout for consistent theming
  - [x] Add automatic difference detection algorithm (date, payee, amount, category, account)
  - [x] Add confidence calculation logic (exact/likely/possible based on differences)

- [ ] Refine Preview component (Story 2.6)
  - [ ] Review current implementation (likely in import-csv.component.ts or separate component)
  - [ ] Implement virtualized scrolling using Angular CDK Virtual Scroll
  - [ ] Add summary footer with exact format from ai-frontend-prompt.md
  - [ ] Show category suggestions column with confidence indicators
  - [ ] Add learning indicator message: "Ledgerly learns from your corrections to improve future imports"
  - [ ] Test virtualized scrolling performance with 200-300 rows

- [ ] Cross-cutting improvements
  - [x] Set up CSS custom properties (`src/Ledgerly.Web/src/theme/design-tokens.css`)
  - [x] Update global styles with design system tokens (`src/Ledgerly.Web/src/styles.css`)
  - [x] Implement focus indicators (2px teal outline) using CSS custom properties
  - [ ] Run full accessibility audit with axe DevTools on all refined components
  - [ ] Apply design system spacing throughout (1.5rem sections, 1rem components)
  - [ ] Test all responsive breakpoints: 320px, 768px, 1024px, 1366px, 1920px
  - [ ] Validate dark mode across all components (check contrast ratios)
  - [ ] Update component unit tests to reflect UI changes
  - [ ] Create visual regression baseline (if Playwright visual testing enabled)

- [ ] Documentation and validation
  - [ ] Update component documentation with design system references
  - [ ] Create before/after screenshots for each component
  - [ ] Document any deviations from ai-frontend-prompt.md (with justification)
    - Example acceptable deviation: "Used mat-chip instead of custom badge component for consistency with existing Angular Material usage - achieves same visual effect (rounded pill, colored background, small text). See design-system.md Section 6 for Angular Material translation guidance."
    - Example unacceptable deviation: "Skipped responsive breakpoints for mobile due to time constraints" - this violates mobile-first requirement and blocks user workflow
    - All deviations must reference design-system.md Angular Implementation Guide (lines 1402-1631) for framework translation justification
  - [ ] Update front-end-spec.md if any patterns changed

## Definition of Done

- [ ] All acceptance criteria met
- [ ] Components match ai-frontend-prompt.md specifications (or deviations documented with justification per Tasks line 143-145)
- [ ] WCAG AA accessibility audit passes (axe DevTools, 0 critical/serious issues per Success Metrics Validation Commands)
- [ ] Responsive design tested at all breakpoints (320px, 768px, 1024px, 1366px, 1920px)
- [ ] Dark mode styling validated across all components
- [ ] Unit tests updated and passing
- [ ] Visual regression tests passing (if implemented)
- [ ] Code review completed
- [ ] User acceptance testing completed
- [ ] Before/after screenshots documented

## Notes

**Context:** This story addresses critical technical debt from Epic 1-2 where UI components were implemented before ai-frontend-prompt.md was fully integrated into dev agent workflow.

**Why Epic 1-2 Deviated:** The ai-frontend-prompt.md document was created during Epic 2 (Story 2.6) as design patterns emerged, but Epic 1 and early Epic 2 stories (2.1-2.5) were already implemented using basic Angular Material defaults without the comprehensive design system guidance. The dev agent was not explicitly instructed to load ai-frontend-prompt.md in the devLoadAlwaysFiles configuration until after Story 2.6 completion. This story ensures all existing components are brought into alignment with the now-established design system to prevent inconsistency.

**Prevention:** ai-frontend-prompt.md is now included in .bmad-core/core-config.yaml devLoadAlwaysFiles (line 22), ensuring all future UI stories automatically follow design system specifications.

Deviations were assessed as "CRITICAL" requiring structured remediation before proceeding with Epic 3 dashboard development.

**Why First in Epic 3:** Completing this refinement BEFORE new dashboard stories ensures:
1. Consistent design patterns established across the application
2. Design system fully understood by dev team/agents
3. No rework needed after Epic 3 completion
4. Accessibility and responsive patterns validated early

**Priority:** **CRITICAL** - Must be completed before Stories 3.2+ to prevent compounding design inconsistencies.

**Effort Estimate:** 12-16 hours (2-3 hours per component × 5 components + cross-cutting improvements)

**Success Metrics:**
- 0 critical/serious accessibility issues in axe DevTools
- All components render correctly at 320px, 768px, 1024px, 1366px, 1920px
- Dark mode contrast ratios meet WCAG AA (4.5:1 body text, 3:1 large text)
- User can navigate entire CSV import flow using keyboard only

**Success Metrics Validation Commands:**
```bash
# 1. Accessibility Audit (expect 0 critical/serious issues)
npm run test -- --include='**/*.spec.ts' --code-coverage
# Then manually run axe DevTools browser extension on each component

# 2. Responsive Testing
# Manual: Open browser DevTools, test at each breakpoint:
# - 320px (mobile)
# - 768px (tablet)
# - 1024px (small desktop)
# - 1366px (standard desktop)
# - 1920px (large desktop)
# OR automated visual regression (if configured):
npm run e2e:visual-regression

# 3. Dark Mode Contrast Validation
# Manual: Toggle dark mode, use axe DevTools "Color Contrast" checker on:
# - All body text (expect 4.5:1 minimum)
# - All headings/large text (expect 3:1 minimum)
# - All interactive elements

# 4. Keyboard Navigation Test
# Manual: Use only Tab, Enter, Escape, Arrow keys to:
# - Navigate through entire CSV import flow
# - Access all interactive elements (buttons, dropdowns, checkboxes)
# - Close modals with Escape
# - Submit forms with Enter
# Expected: All actions achievable without mouse

# 5. Virtualized Scrolling Performance (Story 2.6 Preview Component)
# Manual: Import CSV with 200-300 rows, verify:
# - Smooth scrolling without jank
# - No lag when scrolling quickly
# - Memory usage stable (check Chrome DevTools Performance tab)
```

**Related Documents:**
- [ai-frontend-prompt.md](../ai-frontend-prompt.md) - PRIMARY specification for this story
- [design-system.md](../architecture/design-system.md) - Design tokens and Angular Material patterns
- [front-end-spec.md](../front-end-spec.md) - Overall UI/UX goals and principles
