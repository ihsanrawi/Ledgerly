# Story 1.2: Integrate and Validate hledger Binary

## Status
Approved

## Story

**As a** developer,
**I want** to embed hledger binary and validate process execution works cross-platform,
**so that** I can confidently use hledger for all double-entry calculations.

## Acceptance Criteria

1. hledger binaries downloaded for Windows, macOS, Linux (from hledger.org)
2. HledgerBinaryManager.cs extracts binaries to app resources, sets permissions, SHA256 verifies
3. HledgerProcessRunner.cs executes `hledger --version` successfully on all platforms
4. Test executes `hledger bal -f test.hledger` and parses output
5. Cross-platform builds validated (Windows .exe, macOS .dmg, Linux .AppImage)
6. Decision by end of Week 1: Proceed with Tauri OR pivot to Electron if process spawning issues found

## Tasks / Subtasks

- [ ] Download and Prepare hledger Binaries (AC: 1)
  - [ ] Download hledger 1.32.3 binaries from hledger.org for Windows (x64), macOS (arm64, x64), Linux (x64)
  - [ ] Verify binary integrity using SHA256 checksums from hledger release page
  - [ ] Create `src/Ledgerly.Api/Resources/Binaries/` directory
  - [ ] Add binaries to project as embedded resources in `.csproj` file
  - [ ] Document binary sources and checksums in `src/Ledgerly.Api/Resources/Binaries/README.md`

- [ ] Implement HledgerBinaryManager.cs (AC: 2)
  - [ ] Create `src/Ledgerly.Api/Common/Hledger/HledgerBinaryManager.cs`
  - [ ] Implement `Task<string> GetHledgerBinaryPath()` - detects platform, extracts binary on first run
  - [ ] Implement `Task<bool> ValidateBinary()` - SHA256 verification and `hledger --version` execution
  - [ ] Implement `Task ExtractEmbeddedBinary()` - extracts from embedded resources to `%APPDATA%/Ledgerly/bin/`
  - [ ] Implement `Task<string> GetHledgerVersion()` - returns version string (e.g., "1.32.3")
  - [ ] Set executable permissions on Unix platforms (chmod +x)
  - [ ] Add structured logging with Serilog for all operations

- [ ] Implement HledgerProcessRunner.cs (AC: 3, 4)
  - [ ] Create `src/Ledgerly.Api/Common/Hledger/HledgerProcessRunner.cs`
  - [ ] Implement `Task<string> ExecuteCommand(string command, string[] args)` - generic CLI wrapper
  - [ ] Implement `Task<HledgerBalanceResult> GetBalances(string hledgerFilePath)` - executes `hledger bal -O json`
  - [ ] Implement `Task<ValidationResult> ValidateFile(string hledgerFilePath)` - executes `hledger check`
  - [ ] Configure process execution: redirect stdout/stderr, 30-second timeout, UTF-8 encoding
  - [ ] Parse JSON output using `System.Text.Json`
  - [ ] Handle error exit codes: map to HledgerProcessException with stderr details
  - [ ] Add correlation ID to all log messages

- [ ] Create Test Data and Integration Tests (AC: 4)
  - [ ] Create `tests/TestData/sample.hledger` with 10 test transactions
  - [ ] Create integration test: `HledgerBinaryManagerTests.cs`
    - [ ] Test: Binary extraction succeeds on first run
    - [ ] Test: SHA256 verification passes
    - [ ] Test: `hledger --version` returns expected version string
  - [ ] Create integration test: `HledgerProcessRunnerTests.cs`
    - [ ] Test: Execute `hledger bal -f sample.hledger` and parse JSON output
    - [ ] Test: Execute `hledger check` on valid file returns success
    - [ ] Test: Execute `hledger check` on invalid file returns error with details
    - [ ] Test: Timeout after 30 seconds for long-running commands
    - [ ] Test: Handle stderr output for parse errors
  - [ ] Follow test organization: Co-locate tests in `Common/Hledger/Hledger.Tests/`

- [ ] Validate Cross-Platform Builds (AC: 5)
  - [ ] Build Tauri app for Windows: `cargo tauri build --target x86_64-pc-windows-msvc`
  - [ ] Build Tauri app for macOS: `cargo tauri build --target aarch64-apple-darwin`
  - [ ] Build Tauri app for Linux: `cargo tauri build --target x86_64-unknown-linux-gnu`
  - [ ] Test hledger binary extraction and execution on each platform
  - [ ] Verify file permissions are set correctly on Unix platforms
  - [ ] Document build commands in `scripts/build-all.sh`

- [ ] Week 1 Validation Gate - Tauri Process Spawning (AC: 6)
  - [ ] Execute E2E test: Launch Tauri app → spawn hledger process → verify output
  - [ ] Test native file I/O: Read .hledger file from user-selected directory
  - [ ] Test process spawning on Windows, macOS, Linux
  - [ ] Document validation results in story completion notes
  - [ ] If validation fails: Document Electron fallback plan and blockers

## Dev Notes

### Tech Stack References
[Source: architecture/tech-stack.md#technology-stack-table]

**Key Technologies for This Story:**
- **hledger Binary:** Version 1.32.3 (embedded binary, GPL-compliant subprocess)
- **Platform Detection:** `RuntimeInformation.IsOSPlatform()` (.NET built-in)
- **Process Execution:** `System.Diagnostics.Process` with timeout configuration
- **JSON Parsing:** `System.Text.Json` for hledger `-O json` output
- **Logging:** Serilog 3.1.1 structured logging
- **Testing:** xUnit 2.7.0, NSubstitute 5.1.0 for mocking
- **Tauri:** Version 1.6.1 (Week 1 validation required)
- **Fallback:** Electron 29.1.0 if Tauri validation fails

### HledgerBinaryManager Component Specification
[Source: architecture/components.md#hledgerbinarymanager]

**Responsibility:** Manages embedded hledger binaries across platforms (Windows/macOS/Linux). Handles extraction, permissions, version verification, and platform detection.

**Key Interfaces:**
- `Task<string> GetHledgerBinaryPath()` - Returns path to platform-appropriate hledger executable
- `Task<bool> ValidateBinary()` - Verifies SHA256 hash and executes `hledger --version`
- `Task ExtractEmbeddedBinary()` - Extracts from embedded resources on first launch
- `Task<string> GetHledgerVersion()` - Returns hledger version string (e.g., "1.32.3")

**Dependencies:**
- File system I/O (System.IO)
- Platform detection (RuntimeInformation)
- Embedded resources (Assembly.GetManifestResourceStream)

**Technology Stack:**
- **Platform Detection:** `RuntimeInformation.IsOSPlatform(OSPlatform.Windows/Linux/OSX)`
- **Embedded Binaries:** hledger 1.32.3 (Windows .exe, macOS arm64/x64, Linux x64)

**Extraction Location:** `%APPDATA%/Ledgerly/bin/` on Windows, `~/.local/share/Ledgerly/bin/` on Linux/macOS

**Binary Naming:**
- Windows: `hledger-windows-x64.exe`
- macOS ARM64: `hledger-macos-arm64`
- macOS x64: `hledger-macos-x64`
- Linux x64: `hledger-linux-x64`

### HledgerProcessRunner Component Specification
[Source: architecture/components.md#hledgerprocessrunner]

**Responsibility:** Executes hledger CLI commands via ProcessStartInfo, captures output (stdout/stderr), parses JSON/text responses, handles errors.

**Key Interfaces:**
- `Task<HledgerBalanceResult> GetBalances(string hledgerFilePath, string[]? accounts = null)` - Executes `hledger bal -O json`
- `Task<HledgerRegisterResult> GetRegister(string hledgerFilePath, DateRange? dateRange = null)` - Executes `hledger reg`
- `Task<ValidationResult> ValidateFile(string hledgerFilePath)` - Executes `hledger check`
- `Task<string> ExecuteCommand(string command, string[] args)` - Generic CLI execution wrapper

**Dependencies:**
- **HledgerBinaryManager** (gets binary path)
- Process execution (System.Diagnostics.Process)
- JSON parsing (System.Text.Json)
- Serilog (structured logging with correlation IDs)

**Technology Stack:**
- **Process Execution:** `ProcessStartInfo` with `RedirectStandardOutput = true`
- **JSON Parsing:** `System.Text.Json` for `hledger -O json` output
- **Timeout:** 30 seconds default (configurable for large files)

**Process Configuration:**
- Redirect StandardOutput and StandardError
- Set WorkingDirectory to .hledger file directory
- Use UTF-8 encoding
- Kill process on timeout
- Capture exit code for error handling

### Error Handling for hledger CLI
[Source: architecture/error-handling-strategy.md#external-api-errors-hledger-cli]

**Retry Policy:**
- Transient errors (timeout): Exponential backoff, max 3 retries
- Permanent errors (invalid syntax): Fail immediately

**Timeout Configuration:**
- Default: 30 seconds
- Large files (>50K transactions): 60 seconds

**hledger Exit Code Mapping:**
| Exit Code | Meaning | Action |
|-----------|---------|--------|
| 0 | Success | Continue |
| 1 | Validation error | Throw HledgerValidationException with stderr |
| 2 | Parse error | Throw HledgerParseException with stderr |
| 127 | Binary not found | Throw HledgerBinaryNotFoundException |

**Exception Hierarchy:**
```
HledgerException (base)
├── HledgerValidationException (hledger check failures)
├── HledgerBinaryNotFoundException
├── HledgerProcessException (CLI execution failures)
└── HledgerParseException (output parsing failures)
```

**Error Response Example:**
```csharp
try
{
    var result = await _processRunner.ExecuteCommand("hledger", ["check", filePath]);
}
catch (ProcessExecutionException ex) when (ex.ExitCode == 1)
{
    var errorMessage = ParseHledgerError(ex.StdErr);
    throw new HledgerValidationException(errorMessage, ex);
}
```

### Project Structure Alignment
[Source: architecture/source-tree.md#vsa-feature-slice-pattern]

**File Locations:**
- `src/Ledgerly.Api/Common/Hledger/HledgerBinaryManager.cs`
- `src/Ledgerly.Api/Common/Hledger/HledgerProcessRunner.cs`
- `src/Ledgerly.Api/Common/Hledger/Hledger.Tests/HledgerBinaryManagerTests.cs`
- `src/Ledgerly.Api/Common/Hledger/Hledger.Tests/HledgerProcessRunnerTests.cs`
- `src/Ledgerly.Api/Common/Exceptions/HledgerException.cs`
- `src/Ledgerly.Api/Common/Exceptions/HledgerValidationException.cs`
- `src/Ledgerly.Api/Common/Exceptions/HledgerBinaryNotFoundException.cs`
- `src/Ledgerly.Api/Common/Exceptions/HledgerProcessException.cs`
- `src/Ledgerly.Api/Common/Exceptions/HledgerParseException.cs`
- `src/Ledgerly.Api/Resources/Binaries/hledger-windows-x64.exe`
- `src/Ledgerly.Api/Resources/Binaries/hledger-macos-arm64`
- `src/Ledgerly.Api/Resources/Binaries/hledger-macos-x64`
- `src/Ledgerly.Api/Resources/Binaries/hledger-linux-x64`
- `src/Ledgerly.Api/Resources/Binaries/README.md`
- `tests/TestData/sample.hledger`

**Embedded Resource Configuration (.csproj):**
```xml
<ItemGroup>
  <EmbeddedResource Include="Resources/Binaries/hledger-windows-x64.exe" />
  <EmbeddedResource Include="Resources/Binaries/hledger-macos-arm64" />
  <EmbeddedResource Include="Resources/Binaries/hledger-macos-x64" />
  <EmbeddedResource Include="Resources/Binaries/hledger-linux-x64" />
</ItemGroup>
```

### Coding Standards
[Source: architecture/coding-standards.md#critical-rules]

**MANDATORY Rules for This Story:**

1. **Logging Only:** Use Serilog for all logging - never `console.log` or `Console.WriteLine`

2. **Async/Await:** Use `async`/`await` for all I/O operations (file extraction, process execution) - never `.Result` or `.Wait()`

3. **Dependency Injection:** Constructor injection for HledgerBinaryManager and HledgerProcessRunner

4. **Nullable Reference Types:** Enable and respect C# nullable annotations

5. **Error Handling:** Throw specific exceptions (HledgerValidationException, HledgerProcessException) - never generic `Exception`

6. **Correlation IDs:** Include correlation ID in all log messages for tracing

**Exception Handling Pattern:**
```csharp
catch (ProcessExecutionException ex) when (ex.ExitCode == 1)
{
    _logger.LogError(ex, "hledger validation failed: {ErrorMessage}", ex.StdErr);
    throw new HledgerValidationException(ex.StdErr, ex);
}
```

### Previous Story Insights
[Source: Story 1.1 completion notes]

**Key Learnings:**
- Tauri is already configured with process spawning and file I/O permissions in `tauri.conf.json`
- Test command for process spawning already exists in `main.rs` (executes "echo hello")
- Tauri builds successfully with `cargo build` - full cross-platform validation pending Rust installation on all platforms
- Money value object uses integer cents storage - follow same pattern for any monetary amounts in test data
- Correlation ID middleware is configured - ensure hledger process logs include correlation ID from context

**Technical Decisions from 1.1:**
- CORS is hardened to explicit localhost origins - no changes needed for hledger integration
- Global exception handling middleware is in place - will catch unhandled HledgerException types
- Serilog is configured with async file sinks - use `ILogger<HledgerBinaryManager>` for structured logging

### Tauri Week 1 Validation Gate
[Source: architecture/tech-stack.md, architecture/high-level-architecture.md]

**CRITICAL:** This story directly addresses the Week 1 validation gate for Tauri. The decision to proceed with Tauri or pivot to Electron depends on successful process spawning validation.

**Validation Criteria:**
- ✅ Process spawning works (test with hledger binary execution)
- ✅ Native file system access (read .hledger files from user-selected directory)
- ✅ Cross-platform builds succeed (Windows .exe, macOS .dmg, Linux .AppImage)

**Success Criteria:**
- `hledger --version` executes successfully on all platforms
- `hledger bal -f test.hledger` parses output correctly
- No permission errors on Unix platforms (executable permissions set correctly)

**Fallback Plan:**
If Tauri validation fails:
1. Document specific blockers (e.g., permission errors, process spawning limitations)
2. Pivot to Electron 29.1.0 (proven stability, larger bundle acceptable)
3. Update architecture documentation to reflect Electron decision
4. Adjust build scripts for Electron packaging

### Testing

**Test Organization:**
[Source: architecture/test-strategy-and-standards.md#test-types-and-organization]

- **Backend Tests:** Co-located in `Common/Hledger/Hledger.Tests/`
- **Test Naming:** `{Class}Tests.cs` (e.g., `HledgerBinaryManagerTests.cs`)
- **Framework:** xUnit 2.7.0
- **Mocking:** NSubstitute 5.1.0 for file I/O and process execution mocks

**Integration Tests:**
[Source: architecture/test-strategy-and-standards.md#integration-tests]

- **Scope:** Real hledger binary execution with test `.hledger` files
- **Database:** Not needed for this story (hledger integration only)
- **File System:** Use temporary directories, clean up after tests
- **Test Infrastructure:**
  - Create test `.hledger` file in `tests/TestData/sample.hledger`
  - Extract real hledger binary for tests (not mocked)
  - Validate process execution with real CLI output

**Coverage Requirements:**
- **Unit Tests:** 80% minimum code coverage
- **AI Agent Requirements:**
  - Follow AAA pattern (Arrange, Act, Assert)
  - Mock file I/O dependencies where appropriate
  - Cover edge cases: missing binary, invalid SHA256, timeout, parse errors
  - Test all exit code scenarios (0, 1, 2, 127)

**Key Test Scenarios:**
1. Binary extraction succeeds on first run
2. SHA256 verification passes for valid binary
3. SHA256 verification fails for corrupted binary
4. `hledger --version` returns expected version string
5. `hledger bal -f sample.hledger` executes and parses JSON output
6. `hledger check` validates correct .hledger file
7. `hledger check` returns error for invalid .hledger file
8. Process timeout after 30 seconds
9. Handle stderr output for parse errors
10. Executable permissions set correctly on Unix platforms

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-06 | 1.0 | Initial story creation from Epic 1 requirements | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

(To be filled by Dev Agent)

### Debug Log References

(To be filled by Dev Agent)

### Completion Notes List

(To be filled by Dev Agent)

### File List

(To be filled by Dev Agent)

## QA Results

(To be filled by QA Agent)
