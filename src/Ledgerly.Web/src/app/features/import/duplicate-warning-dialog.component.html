<div class="duplicate-dialog">
  <h2 mat-dialog-title>
    <mat-icon class="warning-icon">warning</mat-icon>
    Duplicate Transactions Detected
  </h2>

  <mat-dialog-content>
    <!-- Progress Indicator -->
    <div class="progress-indicator">
      <span class="progress-text">
        Reviewing duplicate {{ currentIndex() + 1 }} of {{ totalDuplicates() }}
      </span>
    </div>

    <!-- Confidence Badge -->
    <div class="confidence-badge-container">
      <mat-chip-set aria-label="Match confidence">
        <mat-chip
          *ngIf="matchConfidence() === 'exact'"
          class="confidence-badge exact">
          <mat-icon>check_circle</mat-icon>
          Exact Match
        </mat-chip>
        <mat-chip
          *ngIf="matchConfidence() === 'likely'"
          class="confidence-badge likely">
          <mat-icon>warning</mat-icon>
          Likely Match
        </mat-chip>
        <mat-chip
          *ngIf="matchConfidence() === 'possible'"
          class="confidence-badge uncertain">
          <mat-icon>help_outline</mat-icon>
          Possible Match
        </mat-chip>
      </mat-chip-set>
    </div>

    <!-- Side-by-Side Comparison -->
    <div class="comparison-container">
      <!-- Existing Transaction (Left) -->
      <mat-card class="transaction-card existing">
        <mat-card-header>
          <mat-card-title>
            <mat-icon class="card-icon">inventory</mat-icon>
            Existing Transaction
          </mat-card-title>
          <mat-card-subtitle>Already in your ledger</mat-card-subtitle>
        </mat-card-header>

        <mat-card-content>
          <div class="transaction-details">
            <div class="detail-row">
              <mat-icon class="detail-icon">event</mat-icon>
              <span class="detail-label">Date:</span>
              <span
                class="detail-value font-mono"
                [class.difference]="isDifferent('date')">
                {{ formatDate(currentDuplicate().date) }}
              </span>
            </div>

            <div class="detail-row">
              <mat-icon class="detail-icon">person</mat-icon>
              <span class="detail-label">Payee:</span>
              <span
                class="detail-value"
                [class.difference]="isDifferent('payee')">
                {{ currentDuplicate().payee }}
              </span>
            </div>

            <div class="detail-row">
              <mat-icon class="detail-icon">attach_money</mat-icon>
              <span class="detail-label">Amount:</span>
              <span
                class="detail-value amount font-mono"
                [class.difference]="isDifferent('amount')">
                {{ formatCurrency(currentDuplicate().amount) }}
              </span>
            </div>

            <div class="detail-row">
              <mat-icon class="detail-icon">category</mat-icon>
              <span class="detail-label">Category:</span>
              <span
                class="detail-value"
                [class.difference]="isDifferent('category')">
                {{ currentDuplicate().category }}
              </span>
            </div>

            <div class="detail-row">
              <mat-icon class="detail-icon">account_balance</mat-icon>
              <span class="detail-label">Account:</span>
              <span
                class="detail-value"
                [class.difference]="isDifferent('account')">
                {{ currentDuplicate().account }}
              </span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- New Transaction (Right) -->
      <mat-card class="transaction-card new">
        <mat-card-header>
          <mat-card-title>
            <mat-icon class="card-icon">add_circle</mat-icon>
            New Transaction
          </mat-card-title>
          <mat-card-subtitle>From CSV import</mat-card-subtitle>
        </mat-card-header>

        <mat-card-content>
          <div class="transaction-details">
            <div class="detail-row">
              <mat-icon class="detail-icon">event</mat-icon>
              <span class="detail-label">Date:</span>
              <span
                class="detail-value font-mono"
                [class.difference]="isDifferent('date')">
                {{ formatDate(getNewValue('date')) }}
              </span>
            </div>

            <div class="detail-row">
              <mat-icon class="detail-icon">person</mat-icon>
              <span class="detail-label">Payee:</span>
              <span
                class="detail-value"
                [class.difference]="isDifferent('payee')">
                {{ getNewValue('payee') }}
              </span>
            </div>

            <div class="detail-row">
              <mat-icon class="detail-icon">attach_money</mat-icon>
              <span class="detail-label">Amount:</span>
              <span
                class="detail-value amount font-mono"
                [class.difference]="isDifferent('amount')">
                {{ formatCurrency(parseAmount(getNewValue('amount'))) }}
              </span>
            </div>

            <div class="detail-row">
              <mat-icon class="detail-icon">category</mat-icon>
              <span class="detail-label">Category:</span>
              <span
                class="detail-value"
                [class.difference]="isDifferent('category')">
                {{ getNewValue('category') || 'Not categorized' }}
              </span>
            </div>

            <div class="detail-row">
              <mat-icon class="detail-icon">account_balance</mat-icon>
              <span class="detail-label">Account:</span>
              <span
                class="detail-value"
                [class.difference]="isDifferent('account')">
                {{ getNewValue('account') || 'Default' }}
              </span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Explanation -->
    <div class="explanation">
      <mat-icon>info</mat-icon>
      <p>
        <span *ngIf="matchConfidence() === 'exact'">
          These transactions are identical. Skip to avoid duplication.
        </span>
        <span *ngIf="matchConfidence() === 'likely'">
          These transactions are very similar. Skip to avoid duplication, or import if this is a legitimate duplicate charge.
        </span>
        <span *ngIf="matchConfidence() === 'possible'">
          These transactions have some similarities but differ in key fields. Review carefully before deciding.
        </span>
      </p>
      <p *ngIf="differences().length > 0" class="differences-list">
        <strong>Differences:</strong> {{ differences().join(', ') }}
      </p>
    </div>

    <!-- Current Decision Status -->
    <div *ngIf="getDecisionForCurrent()" class="decision-status">
      <mat-icon [class.skip-icon]="getDecisionForCurrent() === 'skip'"
                [class.import-icon]="getDecisionForCurrent() === 'import'">
        {{ getDecisionForCurrent() === 'skip' ? 'block' : 'check_circle' }}
      </mat-icon>
      <span>
        {{ getDecisionForCurrent() === 'skip' ? 'Marked to Skip' : 'Marked to Import' }}
      </span>
    </div>
  </mat-dialog-content>

  <mat-dialog-actions align="end">
    <!-- Navigation Buttons -->
    <div class="navigation-buttons">
      <button
        mat-button
        (click)="previous()"
        [disabled]="!hasPrevious()"
        aria-label="Previous duplicate">
        <mat-icon>arrow_back</mat-icon>
        Previous
      </button>
      <button
        mat-button
        (click)="next()"
        [disabled]="!hasNext()"
        aria-label="Next duplicate">
        Next
        <mat-icon>arrow_forward</mat-icon>
      </button>
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons">
      <button
        mat-button
        (click)="skipAllRemaining()"
        [disabled]="getRemainingCount() === 1"
        aria-label="Skip all remaining duplicates"
        class="skip-all-button">
        <mat-icon>skip_next</mat-icon>
        Skip All Remaining ({{ getRemainingCount() }})
      </button>
      <button
        mat-raised-button
        color="warn"
        (click)="skipDuplicate()"
        aria-label="Skip this duplicate">
        <mat-icon>block</mat-icon>
        Skip This
      </button>
      <button
        mat-raised-button
        color="primary"
        (click)="importAnyway()"
        aria-label="Import this transaction anyway">
        <mat-icon>check_circle</mat-icon>
        Import Anyway
      </button>
    </div>
  </mat-dialog-actions>
</div>
